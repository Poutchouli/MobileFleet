{% extends "base.html" %}

{% block title %}{{ _('Manage Users') }} - {{ _('Admin') }}{% endblock %}

{% block page_title %}{{ _('Manage System Users') }}{% endblock %}

{% block content %}
<div class="custom-card">
    <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-semibold">{{ _('User Accounts') }}</h2>
        <button id="add-user-btn" class="btn btn-primary">
            {{ _('Add New User') }}
        </button>
    </div>
    <table class="custom-table">
        <thead>
            <tr>
                <th>{{ _('Username') }}</th>
                <th>{{ _('Full Name') }}</th>
                <th>{{ _('Email') }}</th>
                <th>{{ _('Role') }}</th>
                <th class="text-right">{{ _('Actions') }}</th>
            </tr>
        </thead>
        <tbody id="users-table-body">
            <!-- JS will populate this -->
        </tbody>
    </table>
</div>

<!-- Add/Edit User Modal -->
<div id="user-modal" class="custom-modal hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="custom-modal-backdrop"></div>
    <div class="custom-modal-content">
        <div class="custom-modal-header">
            <h3 id="modal-title" class="custom-modal-title">{{ _('Add New User') }}</h3>
        </div>
        <form id="user-form" class="custom-form">
            <div class="custom-modal-body">
                <input type="hidden" id="user-db-id" name="id">
                <div class="custom-form-grid">
                    <div class="custom-form-group">
                        <label for="username" class="custom-label">{{ _('Username') }}*</label>
                        <input type="text" name="username" id="username" required class="custom-input">
                    </div>
                    <div class="custom-form-group">
                        <label for="full_name" class="custom-label">{{ _('Full Name') }}*</label>
                        <input type="text" name="full_name" id="full_name" required class="custom-input">
                    </div>
                    <div class="custom-form-group custom-form-group-full">
                        <label for="email" class="custom-label">{{ _('Email') }}*</label>
                        <input type="email" name="email" id="email" required class="custom-input">
                    </div>
                    <div class="custom-form-group">
                        <label for="role_id" class="custom-label">{{ _('Role') }}*</label>
                        <select id="role_id" name="role_id" required class="custom-select">
                            <!-- Options populated by JS -->
                        </select>
                    </div>
                    <div id="password-field-container" class="custom-form-group">
                        <label for="password" class="custom-label">{{ _('Password') }}*</label>
                        <input type="password" name="password" id="password" required class="custom-input">
                    </div>
                </div>
            </div>
            <div class="custom-modal-footer">
                <button type="submit" class="btn btn-primary">{{ _('Save') }}</button>
                <button type="button" id="cancel-btn" class="btn btn-secondary">{{ _('Cancel') }}</button>
            </div>
        </form>
    </div>
</div>

<div id="toast" class="fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg hidden"><p id="toast-message"></p></div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const modal = document.getElementById('user-modal');
        const addUserBtn = document.getElementById('add-user-btn');
        const cancelBtn = document.getElementById('cancel-btn');
        const userForm = document.getElementById('user-form');
        const modalTitle = document.getElementById('modal-title');
        const tableBody = document.getElementById('users-table-body');
        const roleSelect = document.getElementById('role_id');
        const passwordContainer = document.getElementById('password-field-container');
        const passwordInput = document.getElementById('password');
        const toastMessage = document.getElementById('toast-message');

        let rolesData = [];

        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            toastMessage.textContent = message;
            toast.className = `fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg ${isError ? 'bg-red-500' : 'bg-green-500'}`;
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 3000);
        }

        function openModal() { modal.classList.remove('hidden'); }
        function closeModal() { modal.classList.add('hidden'); userForm.reset(); document.getElementById('user-db-id').value = ''; }

        addUserBtn.addEventListener('click', () => {
            modalTitle.textContent = 'Add New User';
            passwordContainer.style.display = 'block';
            passwordInput.required = true;
            document.getElementById('username').readOnly = false;
            openModal();
        });
        cancelBtn.addEventListener('click', closeModal);

        async function fetchRoles() {
            try {
                const response = await fetch('/api/roles');
                rolesData = await response.json();
                roleSelect.innerHTML = '<option value="">Select a role</option>';
                rolesData.forEach(role => {
                    roleSelect.innerHTML += `<option value="${role.id}">${role.role_name}</option>`;
                });
            } catch (error) { showToast('Could not load roles.', true); }
        }

        async function fetchUsers() {
            try {
                const response = await fetch('/api/users');
                const users = await response.json();
                renderTable(users);
            } catch (error) { showToast('Could not load users.', true); }
        }

        function renderTable(users) {
            tableBody.innerHTML = '';
            users.forEach(user => {
                const row = `
                    <tr data-user='${JSON.stringify(user)}'>
                        <td>${user.username}</td>
                        <td>${user.full_name}</td>
                        <td>${user.email}</td>
                        <td>${user.role_name}</td>
                        <td class="text-right">
                            <button data-id="${user.id}" class="edit-btn btn-link">Edit</button>
                        </td>
                    </tr>
                `;
                tableBody.insertAdjacentHTML('beforeend', row);
            });
        }

        userForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(userForm);
            const userData = Object.fromEntries(formData.entries());
            const userDbId = userData.id;
            
            const url = userDbId ? `/api/users/${userDbId}` : '/api/users';
            const method = userDbId ? 'PUT' : 'POST';

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(userData)
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.error || 'Failed to save user.');
                showToast(`User successfully ${userDbId ? 'updated' : 'created'}!`);
                closeModal();
                fetchUsers();
            } catch (error) { showToast(error.message, true); }
        });

        tableBody.addEventListener('click', async function(e) {
            if (e.target.classList.contains('edit-btn')) {
                const row = e.target.closest('tr');
                const user = JSON.parse(row.dataset.user);
                
                document.getElementById('user-db-id').value = user.id;
                document.getElementById('username').value = user.username;
                document.getElementById('username').readOnly = true; // Don't allow username change
                document.getElementById('full_name').value = user.full_name;
                document.getElementById('email').value = user.email;

                const role = rolesData.find(r => r.role_name === user.role_name);
                if (role) document.getElementById('role_id').value = role.id;
                
                // Hide password field for editing
                passwordContainer.style.display = 'none';
                passwordInput.required = false;

                modalTitle.textContent = 'Edit User';
                openModal();
            }
        });

        fetchRoles();
        fetchUsers();
    });
</script>
{% endblock %}
