{% extends "base.html" %}

{% block title %}Manage Roles - Admin{% endblock %}

{% block page_title %}Manage System Roles{% endblock %}

{% block content %}
<div class="grid grid-cols-1 md:grid-cols-3 gap-6">
    <!-- Existing Roles List -->
    <div class="md:col-span-2 custom-card">
        <h2 class="text-xl font-semibold mb-4">Existing Roles</h2>
        <ul id="roles-list" class="space-y-3">
            <!-- JS will populate this -->
        </ul>
    </div>

    <!-- Add New Role Form -->
    <div class="custom-card">
        <h2 class="text-xl font-semibold mb-4">Add New Role</h2>
        <form id="add-role-form" class="space-y-4">
            <div class="form-group">
                <label for="role_name" class="form-label">Role Name*</label>
                <input type="text" name="role_name" id="role_name" required class="form-input">
            </div>
            <div class="form-group">
                <label for="description" class="form-label">Description</label>
                <textarea name="description" id="description" rows="3" class="form-input"></textarea>
            </div>
            <div>
                <button type="submit" class="btn btn-primary w-full">
                    Create Role
                </button>
            </div>
        </form>
    </div>
</div>

<div id="toast" class="toast hidden">
    <p id="toast-message"></p>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const rolesList = document.getElementById('roles-list');
        const addRoleForm = document.getElementById('add-role-form');

        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            toastMessage.textContent = message;
            toast.className = `toast ${isError ? 'toast-error' : 'toast-success'}`;
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 3000);
        }

        async function fetchRoles() {
            try {
                const response = await fetch('/api/roles');
                if (!response.ok) throw new Error('Could not fetch roles.');
                const roles = await response.json();
                renderRoles(roles);
            } catch (error) {
                showToast(error.message, true);
            }
        }

        function renderRoles(roles) {
            rolesList.innerHTML = '';
            if (roles.length === 0) {
                rolesList.innerHTML = '<p class="text-gray-500">No roles found.</p>';
                return;
            }
            roles.forEach(role => {
                const roleItem = `
                    <li class="p-4 border rounded-md bg-gray-50">
                        <h3 class="font-semibold text-gray-900">${role.role_name}</h3>
                        <p class="text-sm text-gray-600">${role.description || 'No description provided.'}</p>
                    </li>
                `;
                rolesList.insertAdjacentHTML('beforeend', roleItem);
            });
        }

        addRoleForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(addRoleForm);
            const roleData = Object.fromEntries(formData.entries());

            try {
                const response = await fetch('/api/roles', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(roleData)
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.error || 'Failed to create role.');
                
                showToast('Role created successfully!');
                addRoleForm.reset();
                fetchRoles(); // Refresh the list
            } catch (error) {
                showToast(error.message, true);
            }
        });

        // Initial Load
        fetchRoles();
    });
</script>
{% endblock %}
