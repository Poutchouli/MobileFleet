{% extends "base.html" %}

{% block title %}Assign Secteurs to Managers{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <div class="bg-white rounded-lg shadow-md p-6">
        <h1 class="text-2xl font-bold text-gray-800 mb-6">üè¢ Assign Secteurs to Managers</h1>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- Manager Selection -->
            <div class="md:col-span-1">
                <h3 class="text-lg font-medium mb-4 text-gray-700">1. Select a Manager</h3>
                <div class="bg-gray-50 p-4 rounded-lg">
                    <select id="manager-select" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">-- Choose a manager --</option>
                    </select>
                </div>
            </div>

            <!-- Secteur Assignment -->
            <div class="md:col-span-2">
                <h3 class="text-lg font-medium mb-4 text-gray-700">2. Assign Secteurs</h3>
                <div id="secteurs-container" class="bg-gray-50 p-4 rounded-lg border min-h-[200px]">
                    <p class="text-gray-500 text-center">Please select a manager to see available secteurs.</p>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex justify-between items-center mt-6 pt-4 border-t border-gray-200">
            <div id="status-message" class="text-sm text-gray-600"></div>
            <button id="save-button" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-6 rounded-md transition duration-200 disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                Save Changes
            </button>
        </div>
    </div>
</div>

<style>
    .secteur-checkbox {
        transition: all 0.2s ease;
    }
    .secteur-checkbox:hover {
        background-color: #f8fafc;
        transform: translateY(-1px);
    }
    .secteur-checkbox.checked {
        background-color: #e0f2fe;
        border-color: #0369a1;
    }
    .loading {
        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const managerSelect = document.getElementById('manager-select');
    const secteursContainer = document.getElementById('secteurs-container');
    const saveButton = document.getElementById('save-button');
    const statusMessage = document.getElementById('status-message');

    let allSecteurs = []; // Store the list of all sectors
    let currentManagerId = null;

    // Show status message
    function showStatus(message, type = 'info') {
        statusMessage.textContent = message;
        statusMessage.className = `text-sm ${type === 'error' ? 'text-red-600' : type === 'success' ? 'text-green-600' : 'text-gray-600'}`;
    }

    // Initial load: Get all managers and all sectors
    showStatus('Loading managers and secteurs...');
    fetch('/api/manager-secteur-assignments')
        .then(response => {
            if (!response.ok) throw new Error('Failed to load data');
            return response.json();
        })
        .then(data => {
            allSecteurs = data.secteurs;
            
            // Populate manager dropdown
            data.managers.forEach(manager => {
                const option = new Option(manager.full_name, manager.id);
                managerSelect.add(option);
            });
            
            showStatus(`Loaded ${data.managers.length} managers and ${data.secteurs.length} secteurs`);
        })
        .catch(error => {
            console.error('Error loading initial data:', error);
            secteursContainer.innerHTML = `<p class="text-red-500 text-center">‚ùå Error loading data: ${error.message}</p>`;
            showStatus('Failed to load initial data', 'error');
        });

    // Event handler for when a manager is selected
    managerSelect.addEventListener('change', () => {
        const managerId = managerSelect.value;
        currentManagerId = managerId;
        
        secteursContainer.innerHTML = '<div class="loading text-center py-8"><p class="text-gray-500">Loading assigned secteurs...</p></div>';
        saveButton.disabled = true;

        if (!managerId) {
            secteursContainer.innerHTML = `<p class="text-gray-500 text-center">Please select a manager to see available secteurs.</p>`;
            showStatus('');
            return;
        }

        // Fetch the sectors assigned to this specific manager
        fetch(`/api/manager-secteur-assignments?manager_id=${managerId}`)
            .then(response => {
                if (!response.ok) throw new Error('Failed to load assignments');
                return response.json();
            })
            .then(data => {
                renderSecteurCheckboxes(data.assigned_secteur_ids);
                saveButton.disabled = false;
                showStatus(`Manager selected. ${data.assigned_secteur_ids.length} secteurs currently assigned.`);
            })
            .catch(error => {
                console.error('Error fetching assignments:', error);
                secteursContainer.innerHTML = `<p class="text-red-500 text-center">‚ùå Error fetching assignments: ${error.message}</p>`;
                showStatus('Failed to load assignments', 'error');
            });
    });

    // Event handler for the save button
    saveButton.addEventListener('click', () => {
        const checkedBoxes = document.querySelectorAll('#secteurs-container input[type="checkbox"]:checked');
        const secteurIds = Array.from(checkedBoxes).map(cb => cb.value);

        saveButton.textContent = 'Saving...';
        saveButton.disabled = true;
        showStatus('Saving assignments...');

        fetch('/api/manager-secteur-assignments', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                manager_id: currentManagerId,
                secteur_ids: secteurIds
            })
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => { throw new Error(err.error || 'Save failed') });
            }
            return response.json();
        })
        .then(data => {
            showStatus(`‚úÖ ${data.message} (${secteurIds.length} secteurs assigned)`, 'success');
        })
        .catch(error => {
            console.error('Error saving assignments:', error);
            showStatus(`‚ùå Error: ${error.message}`, 'error');
        })
        .finally(() => {
            saveButton.textContent = 'Save Changes';
            saveButton.disabled = false;
        });
    });

    // Helper function to display the sector checkboxes
    function renderSecteurCheckboxes(assignedIds) {
        secteursContainer.innerHTML = ''; // Clear previous content
        
        if (allSecteurs.length === 0) {
            secteursContainer.innerHTML = '<p class="text-gray-500 text-center">No secteurs available.</p>';
            return;
        }

        const grid = document.createElement('div');
        grid.className = 'grid grid-cols-1 md:grid-cols-2 gap-3';

        allSecteurs.forEach(secteur => {
            const isChecked = assignedIds.includes(secteur.id);
            const checkboxWrapper = document.createElement('div');
            checkboxWrapper.className = `secteur-checkbox flex items-center p-3 border rounded-lg cursor-pointer ${isChecked ? 'checked' : 'border-gray-200'}`;
            
            checkboxWrapper.innerHTML = `
                <input type="checkbox" id="secteur-${secteur.id}" value="${secteur.id}" 
                       class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" 
                       ${isChecked ? 'checked' : ''}>
                <label for="secteur-${secteur.id}" class="ml-3 text-sm font-medium text-gray-700 cursor-pointer flex-1">
                    ${secteur.secteur_name}
                </label>
            `;
            
            // Add click handler to toggle checkbox
            checkboxWrapper.addEventListener('click', (e) => {
                if (e.target.type !== 'checkbox') {
                    const checkbox = checkboxWrapper.querySelector('input[type="checkbox"]');
                    checkbox.checked = !checkbox.checked;
                }
                // Update visual state
                if (checkboxWrapper.querySelector('input[type="checkbox"]').checked) {
                    checkboxWrapper.classList.add('checked');
                } else {
                    checkboxWrapper.classList.remove('checked');
                }
            });
            
            grid.appendChild(checkboxWrapper);
        });
        
        secteursContainer.appendChild(grid);
    }
});
</script>
{% endblock %}
