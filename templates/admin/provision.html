{% extends "base.html" %}
{% block title %}Provision New Phone{% endblock %}

{% block page_title %}Provision New Phone{% endblock %}

{% block content %}
<main class="p-4 sm:p-6 lg:p-8">
    <div class="max-w-3xl mx-auto">
        <a href="{{ url_for('admin_phones') }}" class="btn-link mb-4 inline-block">&larr; Back to Phone Management</a>
        <h1 class="text-3xl font-bold mb-6">Phone Provisioning Wizard</h1>

        <!-- Wizard Component -->
        <div class="custom-card" id="wizard">
            <!-- Step 1: Identify Phone -->
            <div id="step-1" class="wizard-step active p-6">
                <h2 class="card-title mb-4">Step 1: Identify Phone</h2>
                <p class="text-gray-600 mb-4">Scan or enter the phone's Asset Tag, IMEI, or Serial Number to begin.</p>
                <div class="custom-form-group">
                    <label for="phone-identifier" class="custom-label">Phone Identifier</label>
                    <input type="text" id="phone-identifier" class="custom-input" placeholder="e.g., PHN-003">
                </div>
                <div class="text-right mt-6">
                    <button id="btn-validate-phone" class="btn btn-primary">Find & Validate Phone</button>
                </div>
            </div>

            <!-- Step 2: Checklists -->
            <div id="step-2" class="wizard-step hidden p-6">
                <h2 class="card-title mb-4">Step 2: Pre-Flight Checks</h2>
                <p class="text-gray-600 mb-4">Confirm all physical and software checks have been completed.</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <fieldset class="space-y-2">
                        <legend class="font-medium text-gray-900">Physical Inspection</legend>
                        <div class="relative flex items-start"><div class="flex items-center h-5"><input id="check-screen" type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded"></div><div class="ml-3 text-sm"><label for="check-screen" class="font-medium text-gray-700">Check for screen cracks</label></div></div>
                        <div class="relative flex items-start"><div class="flex items-center h-5"><input id="check-buttons" type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded"></div><div class="ml-3 text-sm"><label for="check-buttons" class="font-medium text-gray-700">Test all physical buttons</label></div></div>
                        <div class="relative flex items-start"><div class="flex items-center h-5"><input id="check-camera" type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded"></div><div class="ml-3 text-sm"><label for="check-camera" class="font-medium text-gray-700">Verify camera function</label></div></div>
                    </fieldset>
                    <fieldset class="space-y-2">
                        <legend class="font-medium text-gray-900">Software Configuration</legend>
                        <div class="relative flex items-start"><div class="flex items-center h-5"><input id="check-wipe" type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded"></div><div class="ml-3 text-sm"><label for="check-wipe" class="font-medium text-gray-700">Wipe to factory settings</label></div></div>
                        <div class="relative flex items-start"><div class="flex items-center h-5"><input id="check-mdm" type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded"></div><div class="ml-3 text-sm"><label for="check-mdm" class="font-medium text-gray-700">Install MDM Profile</label></div></div>
                        <div class="relative flex items-start"><div class="flex items-center h-5"><input id="check-os" type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded"></div><div class="ml-3 text-sm"><label for="check-os" class="font-medium text-gray-700">Update OS to latest</label></div></div>
                    </fieldset>
                </div>
                <div class="flex justify-between mt-6">
                    <button class="btn btn-secondary btn-prev">Previous</button>
                    <button class="btn btn-primary btn-next" disabled>Next</button>
                </div>
            </div>
            
            <!-- Step 3: Assign Assets -->
            <div id="step-3" class="wizard-step hidden p-6">
                <h2 class="card-title mb-4">Step 3: Assign Assets</h2>
                <div class="space-y-4">
                    <div class="custom-form-group">
                        <label for="sim-select" class="custom-label">Assign SIM Card</label>
                        <select id="sim-select" class="custom-select"><option>Loading...</option></select>
                    </div>
                    <div class="custom-form-group">
                        <label for="worker-select" class="custom-label">Assign to Worker</label>
                        <select id="worker-select" class="custom-select"><option>Loading...</option></select>
                    </div>
                </div>
                <div class="flex justify-between mt-6">
                    <button class="btn btn-secondary btn-prev">Previous</button>
                    <button class="btn btn-primary btn-next">Next</button>
                </div>
            </div>

            <!-- Step 4: Summary -->
            <div id="step-4" class="wizard-step hidden p-6">
                <h2 class="card-title mb-4">Step 4: Summary & Confirmation</h2>
                <div id="summary-content" class="space-y-3 text-gray-800"></div>
                <div class="flex justify-between mt-6">
                    <button class="btn btn-secondary btn-prev">Previous</button>
                    <button id="btn-finalize" class="btn btn-primary bg-green-600 hover:bg-green-700">Confirm & Assign</button>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- Toast Notification -->
<div id="toast" class="fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg hidden">
    <p id="toast-message"></p>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const wizard = document.getElementById('wizard');
    const steps = Array.from(wizard.querySelectorAll('.wizard-step'));
    let currentStep = 0;
    let provisionData = {}; // To store data across steps

    const toast = document.getElementById('toast');
    const toastMessage = document.getElementById('toast-message');

    function showToast(message, isError = false) {
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toast-message');
        toastMessage.textContent = message;
        toast.className = `fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg ${isError ? 'bg-red-500' : 'bg-green-500'}`;
        toast.classList.remove('hidden');
        setTimeout(() => toast.classList.add('hidden'), 4000);
    }

    function goToStep(stepIndex) {
        steps[currentStep].classList.add('hidden');
        steps[stepIndex].classList.remove('hidden');
        currentStep = stepIndex;
    }

    // --- Step 1 Logic ---
    document.getElementById('btn-validate-phone').addEventListener('click', async () => {
        const identifier = document.getElementById('phone-identifier').value;
        if (!identifier) {
            showToast('Please enter a phone identifier.', true);
            return;
        }
        try {
            const response = await fetch('/api/provision/validate_phone', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ identifier })
            });
            const result = await response.json();
            if (!response.ok) throw new Error(result.error);
            
            provisionData.phone = result;
            showToast(`Validated: ${result.manufacturer} ${result.model} (${result.asset_tag})`);
            goToStep(1);
        } catch (error) {
            showToast(error.message, true);
        }
    });

    // --- Step 2 Logic ---
    const checklists = wizard.querySelectorAll('#step-2 input[type="checkbox"]');
    checklists.forEach(checkbox => {
        checkbox.addEventListener('change', () => {
            const allChecked = Array.from(checklists).every(c => c.checked);
            wizard.querySelector('#step-2 .btn-next').disabled = !allChecked;
        });
    });

    // --- Step 3 Logic ---
    async function populateAssignmentDropdowns() {
        try {
            const response = await fetch('/api/provision/available_assets');
            const data = await response.json();
            
            const simSelect = document.getElementById('sim-select');
            simSelect.innerHTML = '<option value="">Select a SIM...</option>';
            data.sims.forEach(sim => {
                const num = sim.phone_number ? `(${sim.phone_number})` : '';
                simSelect.innerHTML += `<option value="${sim.id}">${sim.iccid} ${num}</option>`;
            });

            const workerSelect = document.getElementById('worker-select');
            workerSelect.innerHTML = '<option value="">Select a Worker...</option>';
            data.workers.forEach(worker => {
                workerSelect.innerHTML += `<option value="${worker.id}">${worker.full_name} (${worker.worker_id})</option>`;
            });
        } catch (error) {
            showToast('Could not load available assets.', true);
        }
    }

    // --- Step 4 Logic ---
    function generateSummary() {
        const simId = document.getElementById('sim-select').value;
        const workerId = document.getElementById('worker-select').value;

        if (!simId || !workerId) {
            showToast('Please select both a SIM and a Worker.', true);
            goToStep(2); // Go back to assignment step
            return false;
        }
        
        provisionData.sim_id = simId;
        provisionData.worker_id = workerId;

        const simText = document.getElementById('sim-select').options[document.getElementById('sim-select').selectedIndex].text;
        const workerText = document.getElementById('worker-select').options[document.getElementById('worker-select').selectedIndex].text;

        document.getElementById('summary-content').innerHTML = `
            <p><strong class="font-semibold">Phone:</strong> ${provisionData.phone.manufacturer} ${provisionData.phone.model} (${provisionData.phone.asset_tag})</p>
            <p><strong class="font-semibold">SIM Card:</strong> ${simText}</p>
            <p><strong class="font-semibold">Assigning to Worker:</strong> ${workerText}</p>
            <p class="mt-4 pt-4 border-t text-sm text-gray-600">Clicking 'Confirm & Assign' will finalize this assignment and update all records.</p>
        `;
        return true;
    }
    
    document.getElementById('btn-finalize').addEventListener('click', async () => {
        const payload = {
            phone_id: provisionData.phone.id,
            sim_id: provisionData.sim_id,
            worker_id: provisionData.worker_id
        };
        try {
            const response = await fetch('/api/provision/finalize', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const result = await response.json();
            if (!response.ok) throw new Error(result.error);

            showToast(result.message);
            setTimeout(() => window.location.href = "{{ url_for('admin_phones') }}", 2000);
        } catch (error) {
            showToast(error.message, true);
        }
    });

    // --- Global Wizard Navigation ---
    wizard.addEventListener('click', (e) => {
        if (e.target.classList.contains('btn-next')) {
            if (currentStep === 1) { // Moving from checklists to assignments
                populateAssignmentDropdowns();
            }
            if (currentStep === 2) { // Moving from assignments to summary
                if (!generateSummary()) return;
            }
            goToStep(currentStep + 1);
        }
        if (e.target.classList.contains('btn-prev')) {
            goToStep(currentStep - 1);
        }
    });
});
</script>
{% endblock %}
