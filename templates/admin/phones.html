{% extends "base.html" %}

{% block title %}{{ _('Manage Phones') }} - {{ _('Admin') }}{% endblock %}

{% block page_title %}{{ _('Manage Phones') }}{% endblock %}

{% block content %}
<div class="custom-card">
    <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-semibold">{{ _('Phone Inventory') }}</h2>
        <div class="flex items-center gap-x-4">
            <a href="{{ url_for('admin_provision_wizard') }}" class="btn btn-secondary">{{ _('Provision Phone') }}</a>
            <button id="add-phone-btn" class="btn btn-primary">{{ _('Add New Phone') }}</button>
        </div>
    </div>
    <table class="custom-table">
        <thead>
            <tr>
                <th>{{ _('Asset Tag') }}</th>
                <th>{{ _('Model') }}</th>
                <th>{{ _('IMEI') }}</th>
                <th>{{ _('Status') }}</th>
                <th class="text-right">{{ _('Actions') }}</th>
            </tr>
        </thead>
        <tbody id="phones-table-body">
            <!-- JS will populate this -->
        </tbody>
    </table>
</div>

<!-- Add/Edit Phone Modal -->
<div id="phone-modal" class="custom-modal hidden">
    <div class="custom-modal-backdrop"></div>
    <div class="custom-modal-content">
        <div class="custom-modal-header">
            <h3 id="modal-title" class="custom-modal-title">Add New Phone</h3>
        </div>
        <form id="phone-form" class="custom-form">
            <div class="custom-modal-body">
                <input type="hidden" id="phone-id" name="id">
                <div class="custom-form-grid">
                    <div class="custom-form-group"><label for="asset_tag" class="custom-label">Asset Tag*</label><input type="text" name="asset_tag" id="asset_tag" required class="custom-input"></div>
                    <div class="custom-form-group"><label for="status" class="custom-label">Status</label><select id="status" name="status" class="custom-select"><option>In Stock</option><option>In Use</option><option>In Repair</option></select></div>
                    <div class="custom-form-group"><label for="imei" class="custom-label">IMEI*</label><input type="text" name="imei" id="imei" required class="custom-input"></div>
                    <div class="custom-form-group"><label for="serial_number" class="custom-label">Serial Number*</label><input type="text" name="serial_number" id="serial_number" required class="custom-input"></div>
                    <div class="custom-form-group"><label for="manufacturer" class="custom-label">Manufacturer</label><input type="text" name="manufacturer" id="manufacturer" class="custom-input"></div>
                    <div class="custom-form-group"><label for="model" class="custom-label">Model</label><input type="text" name="model" id="model" class="custom-input"></div>
                    <div class="custom-form-group"><label for="purchase_date" class="custom-label">Purchase Date</label><input type="date" name="purchase_date" id="purchase_date" class="custom-input"></div>
                    <div class="custom-form-group"><label for="warranty_end_date" class="custom-label">Warranty End</label><input type="date" name="warranty_end_date" id="warranty_end_date" class="custom-input"></div>
                    <div class="custom-form-group custom-form-group-full"><label for="notes" class="custom-label">Notes</label><textarea id="notes" name="notes" rows="3" class="custom-textarea"></textarea></div>
                </div>
            </div>
            <div class="custom-modal-footer">
                <button type="submit" class="btn btn-primary">Save</button>
                <button type="button" id="cancel-btn" class="btn btn-secondary">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- History Log Modal -->
<div id="history-modal" class="custom-modal hidden">
    <div class="custom-modal-backdrop"></div>
    <div class="custom-modal-content">
        <div class="custom-modal-header">
            <h3 id="history-modal-title" class="custom-modal-title">Asset History</h3>
        </div>
        <div class="custom-modal-body max-h-[70vh] overflow-y-auto">
            <ul id="history-list" class="space-y-4">
                <!-- JS will populate this -->
            </ul>
        </div>
        <div class="custom-modal-footer">
            <button type="button" id="history-cancel-btn" class="btn btn-secondary">Close</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const phoneModal = document.getElementById('phone-modal');
        const addPhoneBtn = document.getElementById('add-phone-btn');
        const cancelBtn = document.getElementById('cancel-btn');
        const phoneForm = document.getElementById('phone-form');
        const modalTitle = document.getElementById('modal-title');
        const tableBody = document.getElementById('phones-table-body');
        
        const historyModal = document.getElementById('history-modal');
        const historyModalTitle = document.getElementById('history-modal-title');
        const historyList = document.getElementById('history-list');
        const historyCancelBtn = document.getElementById('history-cancel-btn');

        // --- Utility Functions ---
        function showToast(message, isError = false) { /* Your existing toast logic here */ }
        function openPhoneModal() { phoneModal.classList.remove('hidden'); }
        function closePhoneModal() { phoneModal.classList.add('hidden'); phoneForm.reset(); document.getElementById('phone-id').value = ''; }
        function openHistoryModal() { historyModal.classList.remove('hidden'); }
        function closeHistoryModal() { historyModal.classList.add('hidden'); historyList.innerHTML = ''; }

        addPhoneBtn.addEventListener('click', () => {
            modalTitle.textContent = 'Add New Phone';
            openPhoneModal();
        });
        cancelBtn.addEventListener('click', closePhoneModal);
        historyCancelBtn.addEventListener('click', closeHistoryModal);

        async function fetchPhones() {
            try {
                const response = await fetch('/api/phones');
                if (!response.ok) throw new Error('Failed to fetch phones');
                const phones = await response.json();
                renderTable(phones);
            } catch (error) {
                console.error('Error fetching phones:', error);
            }
        }

        function renderTable(phones) {
            tableBody.innerHTML = '';
            if (phones.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4">No phones found.</td></tr>';
                return;
            }
            phones.forEach(phone => {
                const statusClass = phone.status === 'In Stock' ? 'status-available' : 
                                   phone.status === 'In Use' ? 'status-assigned' : 
                                   'status-maintenance';
                const row = `
                    <tr>
                        <td>${phone.asset_tag}</td>
                        <td>${phone.manufacturer || ''} ${phone.model || ''}</td>
                        <td>${phone.imei}</td>
                        <td><span class="status-badge ${statusClass}">${phone.status}</span></td>
                        <td class="text-right">
                            <button data-id="${phone.id}" data-tag="${phone.asset_tag}" class="history-btn btn-link">History</button>
                            <button data-id="${phone.id}" class="edit-btn btn-link ml-4">Edit</button>
                            <button data-id="${phone.id}" data-tag="${phone.asset_tag}" class="delete-btn btn-link text-red-600 ml-4">Retire</button>
                        </td>
                    </tr>
                `;
                tableBody.insertAdjacentHTML('beforeend', row);
            });
        }

        phoneForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(phoneForm);
            const phoneData = Object.fromEntries(formData.entries());
            const phoneId = phoneData.id;
            const url = phoneId ? `/api/phones/${phoneId}` : '/api/phones';
            const method = phoneId ? 'PUT' : 'POST';

            try {
                const response = await fetch(url, { method: method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(phoneData) });
                const result = await response.json();
                if (!response.ok) throw new Error(result.message || 'Failed to save phone.');
                closePhoneModal();
                fetchPhones();
            } catch (error) {
                console.error('Error saving phone:', error);
            }
        });

        tableBody.addEventListener('click', async function(e) {
            const target = e.target;
            const phoneId = target.dataset.id;

            if (target.classList.contains('edit-btn')) {
                try {
                    const response = await fetch(`/api/phones/${phoneId}`);
                    if (!response.ok) throw new Error('Failed to fetch phone details.');
                    const phone = await response.json();
                    for (const key in phone) {
                        if (phoneForm.elements[key]) {
                            const input = phoneForm.elements[key];
                            if (input.type === 'date' && phone[key]) {
                                input.value = phone[key].split('T')[0];
                            } else {
                                input.value = phone[key];
                            }
                        }
                    }
                    modalTitle.textContent = 'Edit Phone';
                    openPhoneModal();
                } catch (error) {
                    console.error('Error fetching for edit:', error);
                }
            }

            if (target.classList.contains('delete-btn')) {
                const assetTag = target.dataset.tag;
                if (confirm(`Are you sure you want to retire phone ${assetTag}?`)) {
                    try {
                        const response = await fetch(`/api/phones/${phoneId}`, { method: 'DELETE' });
                        if (!response.ok) throw new Error('Failed to retire phone.');
                        fetchPhones();
                    } catch (error) {
                        console.error('Error retiring phone:', error);
                    }
                }
            }
            
            if (target.classList.contains('history-btn')) {
                const assetTag = target.dataset.tag;
                historyModalTitle.textContent = `History for ${assetTag}`;
                try {
                    const response = await fetch(`/api/phones/${phoneId}/history`);
                    if (!response.ok) throw new Error('Could not load history.');
                    const historyData = await response.json();
                    renderHistory(historyData);
                    openHistoryModal();
                } catch (error) {
                    console.error(error);
                }
            }
        });

        function renderHistory(historyData) {
            historyList.innerHTML = '';
            if (historyData.length === 0) {
                historyList.innerHTML = '<li>No history found for this asset.</li>';
                return;
            }
            historyData.forEach(item => {
                const date = new Date(item.event_timestamp).toLocaleString();
                const user = item.user_name ? `by ${item.user_name}` : '';
                const listItem = `
                    <li class="border-l-4 pl-4 border-gray-300">
                        <p class="font-semibold">${item.event_type}</p>
                        <p class="text-sm text-gray-700">${item.details}</p>
                        <p class="text-xs text-gray-500 mt-1">${date} ${user}</p>
                    </li>
                `;
                historyList.insertAdjacentHTML('beforeend', listItem);
            });
        }

        fetchPhones();
    });
</script>
{% endblock %}
