{% extends "base.html" %}

{% block title %}Admin Overview{% endblock %}

{% block page_title %}Global Worker Overview{% endblock %}

{% block content %}
<div class="custom-card mb-4">
    <div class="card-header">
        <h3 class="text-lg font-medium">{{ _('Filters') }}</h3>
    </div>
    <div class="p-4">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="custom-form-group">
                <label for="sector-filter" class="custom-label">{{ _('Filter by Sector') }}</label>
                <select id="sector-filter" class="custom-select">
                    <option value="">{{ _('All Sectors') }}</option>
                </select>
            </div>
            <div class="custom-form-group">
                <label for="worker-status-filter" class="custom-label">{{ _('Worker Status') }}</label>
                <select id="worker-status-filter" class="custom-select">
                    <option value="">{{ _('All Statuses') }}</option>
                    <option value="Active">{{ _('Active') }}</option>
                    <option value="Inactive">{{ _('Inactive') }}</option>
                    <option value="Arrêt">{{ _('Arrêt') }}</option>
                    <option value="Congés">{{ _('Congés') }}</option>
                </select>
            </div>
            <div class="custom-form-group">
                <label for="phone-status-filter" class="custom-label">{{ _('Phone Status') }}</label>
                <select id="phone-status-filter" class="custom-select">
                    <option value="">{{ _('All Phone Statuses') }}</option>
                    <option value="In Use">{{ _('In Use') }}</option>
                    <option value="In Stock">{{ _('In Stock') }}</option>
                    <option value="Under Repair">{{ _('Under Repair') }}</option>
                    <option value="Decommissioned">{{ _('Decommissioned') }}</option>
                </select>
            </div>
            <div class="custom-form-group">
                <label for="worker-search" class="custom-label">{{ _('Search Worker') }}</label>
                <input type="text" id="worker-search" class="custom-input" placeholder="{{ _('Search by name...') }}">
            </div>
        </div>
    </div>
</div>

<div id="workers-grid-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
    <div id="loading-message" class="text-center py-8 text-gray-500 col-span-full">{{ _('Loading workers data...') }}</div>
</div>


<div id="toast" class="toast fixed top-4 right-4 p-4 rounded-md shadow-lg hidden">
    <span id="toast-message"></span>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const workersContainer = document.getElementById('workers-grid-container');
    const loadingMessage = document.getElementById('loading-message');
    const toast = document.getElementById('toast');
    const toastMessage = document.getElementById('toast-message');

    // Filter elements
    const sectorFilter = document.getElementById('sector-filter');
    const workerStatusFilter = document.getElementById('worker-status-filter');
    const phoneStatusFilter = document.getElementById('phone-status-filter');
    const workerSearchFilter = document.getElementById('worker-search');

    let originalWorkersData = [];
    let sectorsList = [];

    function showToast(message, isError = false) {
        toastMessage.textContent = message;
        toast.className = `toast fixed top-4 right-4 p-4 rounded-md shadow-lg ${isError ? 'error' : 'success'}`;
        toast.classList.remove('hidden');
        setTimeout(() => { toast.classList.add('hidden'); }, 3000);
    }

    async function fetchInitialData() {
        try {
            // Fetch workers and sectors in parallel
            const [workersResponse, sectorsResponse] = await Promise.all([
                fetch('/api/admin/all_workers_status'),
                fetch('/api/sectors') 
            ]);

            if (!workersResponse.ok) throw new Error('Failed to load worker data.');
            if (!sectorsResponse.ok) throw new Error('Failed to load sectors.');
            
            originalWorkersData = await workersResponse.json();
            sectorsList = await sectorsResponse.json();

            populateFilters();
            renderWorkers(originalWorkersData);

        } catch (error) {
            console.error('Error loading initial data:', error);
            loadingMessage.innerHTML = `<div class="text-center py-8 text-red-500 col-span-full">${error.message}</div>`;
        }
    }

    function populateFilters() {
        const uniqueSectors = [...new Set(originalWorkersData.map(w => w.secteur_name).filter(Boolean))].sort();
        sectorFilter.innerHTML = '<option value="">{{ _("All Sectors") }}</option>';
        uniqueSectors.forEach(sector => {
            sectorFilter.innerHTML += `<option value="${sector}">${sector}</option>`;
        });
    }

    function renderWorkers(workers) {
        workersContainer.innerHTML = ''; // Clear previous content
        if (!workers || workers.length === 0) {
            workersContainer.innerHTML = '<div class="text-center py-8 text-gray-500 col-span-full">{{ _("No workers found matching your criteria.") }}</div>';
            return;
        }
        workers.forEach(worker => {
            const workerCard = createWorkerCard(worker);
            workersContainer.insertAdjacentHTML('beforeend', workerCard);
        });
    }

    function getCardBackgroundClass(contractType, contractEndDate) {
        if (contractType === 'CDD' && contractEndDate) {
            const today = new Date();
            const endDate = new Date(contractEndDate);
            endDate.setHours(0, 0, 0, 0);
            today.setHours(0, 0, 0, 0);
            const diffDays = Math.ceil((endDate - today) / (1000 * 60 * 60 * 24));

            if (diffDays < 0) return 'bg-red-100 border-red-300';
            if (diffDays <= 10) return 'bg-yellow-100 border-yellow-300';
        }
        return 'bg-white border-gray-200';
    }

    function createWorkerCard(worker) {
        const cardBgClass = getCardBackgroundClass(worker.contract_type, worker.contract_end_date);
        
        // Use a function to render the contract end date warning message
        const renderContractWarning = () => {
            if (worker.contract_type !== 'CDD' || !worker.contract_end_date) return '';

            const today = new Date();
            const endDate = new Date(worker.contract_end_date);
            today.setHours(0, 0, 0, 0);
            endDate.setHours(0, 0, 0, 0);
            const diffDays = Math.ceil((endDate - today) / (1000 * 60 * 60 * 24));
            
            let message = '';
            let colorClass = '';

            if (diffDays < 0) {
                message = `{{ _("Contract expired ${Math.abs(diffDays)} days ago") }}`;
                colorClass = 'bg-red-200 text-red-800';
            } else if (diffDays <= 10) {
                message = `{{ _("Contract ends in") }} ${diffDays} {{ _("days") }}`;
                colorClass = diffDays <= 5 ? 'bg-red-100 text-red-700' : 'bg-yellow-100 text-yellow-700';
            }

            if (!message) return '';

            return `
                <div class="mb-3 p-2 rounded-md ${colorClass}">
                    <div class="flex items-center space-x-2">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>
                        <span class="text-xs font-medium">${message}</span>
                    </div>
                </div>`;
        };

        const sectorOptions = sectorsList.map(s => `<option value="${s.id}" ${worker.secteur_id == s.id ? 'selected' : ''}>${s.name}</option>`).join('');

        return `
            <div id="worker-card-${worker.worker_db_id}" class="worker-card ${cardBgClass} rounded-lg shadow-md border p-4 transition-shadow" 
                 data-worker-name="${worker.worker_name}" 
                 data-worker-status="${worker.status}"
                 data-phone-status="${worker.phone_status || ''}"
                 data-sector-name="${worker.secteur_name || ''}">

                <div class="card-view">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center space-x-3">
                             <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-white font-bold">
                                ${worker.worker_name.split(' ').map(n => n[0] || '').join('').substring(0, 2)}
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-900">${worker.worker_name}</h3>
                                <p class="text-sm text-gray-500">ID: ${worker.worker_id}</p>
                            </div>
                        </div>
                        <span class="status-badge ${worker.status.toLowerCase()}">${worker.status}</span>
                    </div>

                    ${renderContractWarning()}
                    
                    <div class="space-y-2 mb-4">
                        <div class="flex justify-between"><span class="text-sm font-medium text-gray-600">{{ _('Sector') }}:</span><span class="text-sm text-gray-900">${worker.secteur_name || 'N/A'}</span></div>
                        <div class="flex justify-between"><span class="text-sm font-medium text-gray-600">{{ _('Contract') }}:</span><span class="text-sm text-gray-900">${worker.contract_type || 'N/A'}</span></div>
                        <div class="flex justify-between"><span class="text-sm font-medium text-gray-600">{{ _('Contract End') }}:</span><span class="text-sm text-gray-900">${worker.contract_end_date ? new Date(worker.contract_end_date).toLocaleDateString() : 'N/A'}</span></div>
                        <div class="border-t pt-2 mt-2">
                           <div class="flex justify-between"><span class="text-sm font-medium text-gray-600">{{ _('Phone') }}:</span><span class="text-sm text-gray-900">${worker.model || 'No phone assigned'}</span></div>
                           <div class="flex justify-between"><span class="text-sm font-medium text-gray-600">{{ _('Asset Tag') }}:</span><span class="text-sm text-gray-900 font-mono">${worker.asset_tag || 'N/A'}</span></div>
                        </div>
                    </div>
                     <div class="border-t pt-3">
                        <div class="flex items-center justify-end space-x-2">
                            <button class="btn-secondary btn-sm edit-btn" data-worker-id="${worker.worker_db_id}">{{ _('Edit') }}</button>
                        </div>
                    </div>
                </div>

                <div class="edit-view hidden">
                    <h3 class="font-semibold text-gray-900 mb-3">{{ _('Editing Worker') }}</h3>
                    <div class="space-y-3">
                        <div><label class="custom-label">{{ _('Full Name') }}</label><input type="text" name="worker_name" class="custom-input" value="${worker.worker_name}"></div>
                        <div><label class="custom-label">{{ _('Status') }}</label>
                            <select name="status" class="custom-select">
                                <option value="Active" ${worker.status === 'Active' ? 'selected' : ''}>Active</option>
                                <option value="Inactive" ${worker.status === 'Inactive' ? 'selected' : ''}>Inactive</option>
                                <option value="Arrêt" ${worker.status === 'Arrêt' ? 'selected' : ''}>Arrêt</option>
                                <option value="Congés" ${worker.status === 'Congés' ? 'selected' : ''}>Congés</option>
                            </select>
                        </div>
                        <div><label class="custom-label">{{ _('Sector') }}</label><select name="secteur_id" class="custom-select">${sectorOptions}</select></div>
                        <div><label class="custom-label">{{ _('Contract Type') }}</label>
                             <select name="contract_type" class="custom-select">
                                <option value="CDI" ${worker.contract_type === 'CDI' ? 'selected' : ''}>CDI</option>
                                <option value="CDD" ${worker.contract_type === 'CDD' ? 'selected' : ''}>CDD</option>
                                <option value="INTERIM" ${worker.contract_type === 'INTERIM' ? 'selected' : ''}>INTERIM</option>
                            </select>
                        </div>
                        <div><label class="custom-label">{{ _('Contract End Date') }}</label><input type="date" name="contract_end_date" class="custom-input" value="${worker.contract_end_date || ''}"></div>
                    </div>
                    <div class="border-t pt-3 mt-4">
                        <div class="flex items-center justify-end space-x-2">
                            <button class="btn-secondary btn-sm cancel-btn" data-worker-id="${worker.worker_db_id}">{{ _('Cancel') }}</button>
                            <button class="btn-primary btn-sm save-btn" data-worker-id="${worker.worker_db_id}">{{ _('Save') }}</button>
                        </div>
                    </div>
                </div>
            </div>`;
    }

    function applyFilters() {
        const sectorValue = sectorFilter.value;
        const workerStatusValue = workerStatusFilter.value;
        const phoneStatusValue = phoneStatusFilter.value;
        const searchValue = workerSearchFilter.value.toLowerCase();

        const filteredWorkers = originalWorkersData.filter(worker => {
            const workerName = worker.worker_name.toLowerCase();
            const workerStatus = worker.status;
            const phoneStatus = worker.phone_status || '';
            const sectorName = worker.secteur_name || '';

            const matchesSearch = !searchValue || workerName.includes(searchValue);
            const matchesSector = !sectorValue || sectorName === sectorValue;
            const matchesWorkerStatus = !workerStatusValue || workerStatus === workerStatusValue;
            const matchesPhoneStatus = !phoneStatusValue || phoneStatus === phoneStatusValue;
            
            return matchesSearch && matchesSector && matchesWorkerStatus && matchesPhoneStatus;
        });

        renderWorkers(filteredWorkers);
    }
    
    ['change', 'input'].forEach(evt => {
        sectorFilter.addEventListener('change', applyFilters);
        workerStatusFilter.addEventListener('change', applyFilters);
        phoneStatusFilter.addEventListener('change', applyFilters);
        workerSearchFilter.addEventListener('input', applyFilters);
    });

    // --- Event Delegation for Edit/Save/Cancel ---
    workersContainer.addEventListener('click', async function(e) {
        const workerId = e.target.dataset.workerId;
        if (!workerId) return;

        const card = document.getElementById(`worker-card-${workerId}`);
        const viewMode = card.querySelector('.card-view');
        const editMode = card.querySelector('.edit-view');

        // Handle Edit button click
        if (e.target.classList.contains('edit-btn')) {
            viewMode.classList.add('hidden');
            editMode.classList.remove('hidden');
        }

        // Handle Cancel button click
        if (e.target.classList.contains('cancel-btn')) {
            editMode.classList.add('hidden');
            viewMode.classList.remove('hidden');
        }

        // Handle Save button click
        if (e.target.classList.contains('save-btn')) {
            const updatedData = {
                worker_name: card.querySelector('[name="worker_name"]').value,
                status: card.querySelector('[name="status"]').value,
                secteur_id: card.querySelector('[name="secteur_id"]').value,
                contract_type: card.querySelector('[name="contract_type"]').value,
                contract_end_date: card.querySelector('[name="contract_end_date"]').value,
            };
            
            // Basic validation
            if (!updatedData.worker_name) {
                showToast('Worker name cannot be empty.', true);
                return;
            }

            try {
                const response = await fetch(`/api/admin/worker/${workerId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updatedData)
                });

                if (!response.ok) {
                    const errorResult = await response.json();
                    throw new Error(errorResult.error || 'Failed to save changes.');
                }
                
                const savedWorker = await response.json();

                // Update the original data array
                const index = originalWorkersData.findIndex(w => w.worker_db_id == workerId);
                if (index !== -1) {
                   originalWorkersData[index] = { ...originalWorkersData[index], ...savedWorker };
                }

                // Re-render the single card with new data
                card.outerHTML = createWorkerCard(originalWorkersData[index]);
                showToast('Worker updated successfully!');

            } catch (error) {
                showToast(error.message, true);
                console.error('Error saving worker:', error);
            }
        }
    });

    // Initial load
    fetchInitialData();
});
</script>

<style>
    /* Status badges for workers */
    .status-badge {
        padding: 0.25rem 0.65rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: capitalize;
    }
    .status-badge.active { background-color: #d1fae5; color: #065f46; }
    .status-badge.inactive { background-color: #e5e7eb; color: #4b5563; }
    .status-badge.arrêt { background-color: #fee2e2; color: #991b1b; }
    .status-badge.congés { background-color: #fef3c7; color: #92400e; }

    /* Card styling */
    .worker-card { transition: all 0.2s ease-in-out; }
    .worker-card:hover { transform: translateY(-3px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    
    /* Input and Label styles from your custom forms */
    .custom-label { font-weight: 500; color: #374151; }
    .custom-input, .custom-select {
        width: 100%;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        padding: 0.5rem 0.75rem;
        font-size: 0.875rem;
        transition: border-color 0.2s;
    }
    .custom-input:focus, .custom-select:focus {
        outline: none;
        border-color: #2563eb;
        box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2);
    }
    
    /* Button styles */
    .btn-sm { padding: 0.375rem 0.75rem; font-size: 0.875rem; }
    .btn-primary { background-color: #2563eb; color: white; border-radius: 0.375rem; font-weight: 500; }
    .btn-primary:hover { background-color: #1d4ed8; }
    .btn-secondary { background-color: #e5e7eb; color: #374151; border-radius: 0.375rem; font-weight: 500; }
    .btn-secondary:hover { background-color: #d1d5db; }

    /* Toast notifications */
    .toast { transition: opacity 0.3s ease, transform 0.3s ease; }
    .toast.hidden { opacity: 0; transform: translateY(-20px); }
    .toast.success { background-color: #10b981; color: white; }
    .toast.error { background-color: #ef4444; color: white; }
</style>
{% endblock %}