{% extends "base.html" %}

{% block title %}Vue d'ensemble Admin{% endblock %}

{% block page_title %}Vue d'ensemble globale des travailleurs{% endblock %}

{% block content %}
<div class="custom-card mb-4">
    <div class="card-header">
        <h3 class="text-lg font-medium">Options de filtrage et d'affichage</h3>
    </div>
    <div class="p-4">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4 border-b pb-4">
            <div class="custom-form-group">
                <label for="sector-filter" class="custom-label">Filtrer par secteur</label>
                <select id="sector-filter" class="custom-select">
                    <option value="">Tous les secteurs</option>
                </select>
            </div>
            <div class="custom-form-group">
                <label for="worker-status-filter" class="custom-label">Statut du travailleur</label>
                <select id="worker-status-filter" class="custom-select">
                    <option value="">Tous les statuts</option>
                    <option value="Active">Actif</option>
                    <option value="Inactive">Inactif</option>
                    <option value="Arrêt">Arrêt</option>
                    <option value="Congés">Congés</option>
                </select>
            </div>
            <div class="custom-form-group">
                <label for="phone-status-filter" class="custom-label">Statut du téléphone</label>
                <select id="phone-status-filter" class="custom-select">
                    <option value="">Tous les statuts téléphone</option>
                    <option value="In Use">En service</option>
                    <option value="In Stock">En stock</option>
                    <option value="Under Repair">En réparation</option>
                    <option value="Decommissioned">Hors service</option>
                </select>
            </div>
            <div class="custom-form-group">
                <label for="worker-search" class="custom-label">Rechercher un travailleur</label>
                <input type="text" id="worker-search" class="custom-input" placeholder="Rechercher par nom...">
            </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
             <div class="custom-form-group">
                <label for="items-per-page-select" class="custom-label">Afficher par page</label>
                <select id="items-per-page-select" class="custom-select">
                    <option value="25">25</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                    <option value="250">250</option>
                </select>
            </div>
        </div>
    </div>
</div>

<div id="workers-grid-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
    </div>

<div id="pagination-controls" class="flex items-center justify-between mt-6"></div>

<div id="toast" class="toast fixed top-4 right-4 p-4 rounded-md shadow-lg hidden">
    <span id="toast-message"></span>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // ======== STATE MANAGEMENT ========
    let originalWorkersData = [];
    let sectorsList = [];
    let currentPage = 1;
    let itemsPerPage = 25;

    // ======== UI ELEMENTS ========
    const workersContainer = document.getElementById('workers-grid-container');
    const paginationControls = document.getElementById('pagination-controls');
    const toast = document.getElementById('toast');
    const toastMessage = document.getElementById('toast-message');

    // Filters & Display
    const sectorFilter = document.getElementById('sector-filter');
    const workerStatusFilter = document.getElementById('worker-status-filter');
    const phoneStatusFilter = document.getElementById('phone-status-filter');
    const workerSearchFilter = document.getElementById('worker-search');
    const itemsPerPageSelect = document.getElementById('items-per-page-select');

    // ======== FIELD DEFINITIONS ========
    // Fixed visible fields for cards
    const visibleFields = ['secteur_name', 'contract_type', 'contract_end_date', 'model', 'asset_tag', 'phone_status'];

    // ======== DATA FETCHING ========
    async function fetchInitialData() {
        workersContainer.innerHTML = `<div class="text-center py-8 text-gray-500 col-span-full">Chargement des données des travailleurs...</div>`;
        try {
            const [workersResponse, sectorsResponse] = await Promise.all([
                fetch('/api/admin/all_workers_status'),
                fetch('/api/sectors') 
            ]);
            if (!workersResponse.ok || !sectorsResponse.ok) throw new Error('Échec du chargement des données initiales.');
            
            originalWorkersData = await workersResponse.json();
            sectorsList = await sectorsResponse.json();

            populateFilters();
            updateView();
        } catch (error) {
            workersContainer.innerHTML = `<div class="text-center py-8 text-red-500 col-span-full">${error.message}</div>`;
        }
    }

    // ======== RENDERING & UI UPDATES ========
    function populateFilters() {
        const uniqueSectors = [...new Set(originalWorkersData.map(w => w.secteur_name).filter(Boolean))].sort();
        sectorFilter.innerHTML = '<option value="">Tous les Secteurs</option>';
        uniqueSectors.forEach(sector => sectorFilter.innerHTML += `<option value="${sector}">${sector}</option>`);
    }

    function updateView() {
        const filtered = applyFilters();
        renderPaginatedWorkers(filtered);
        renderPaginationControls(filtered.length);
    }
    
    function renderPaginatedWorkers(workers) {
        workersContainer.innerHTML = '';
        if (!workers || workers.length === 0) {
            workersContainer.innerHTML = '<div class="text-center py-8 text-gray-500 col-span-full">Aucun travailleur trouvé correspondant à vos critères.</div>';
            return;
        }

        itemsPerPage = parseInt(itemsPerPageSelect.value, 10);
        const start = (currentPage - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        const paginatedWorkers = workers.slice(start, end);

        paginatedWorkers.forEach(worker => {
            const workerCard = createWorkerCard(worker, 'view');
            workersContainer.insertAdjacentHTML('beforeend', workerCard);
        });
    }

    function renderPaginationControls(totalItems) {
        paginationControls.innerHTML = '';
        const totalPages = Math.ceil(totalItems / itemsPerPage);
        if (totalPages <= 1) return;

        let html = `<div class="text-sm text-gray-700">Page ${currentPage} of ${totalPages}</div>`;
        html += '<div class="flex items-center space-x-2">';
        html += `<button class="btn-secondary btn-sm pagination-btn" data-page="${currentPage - 1}" ${currentPage === 1 ? 'disabled' : ''}>Précédent</button>`;
        html += `<button class="btn-secondary btn-sm pagination-btn" data-page="${currentPage + 1}" ${currentPage === totalPages ? 'disabled' : ''}>Suivant</button>`;
        html += '</div>';
        paginationControls.innerHTML = html;
    }

    // ======== DYNAMIC CARD CREATION ========
    function createWorkerCard(worker, mode = 'view') {
        const cardBgClass = getCardBackgroundClass(worker.contract_type, worker.contract_end_date);
        
        let dynamicFieldsHtml = '';
        if (mode === 'view') {
            const fieldLabels = {
                secteur_name: 'Sector',
                contract_type: 'Contract Type', 
                contract_end_date: 'Contract End',
                model: 'Model',
                asset_tag: 'Asset Tag',
                phone_status: 'Phone Status'
            };
            
            dynamicFieldsHtml = visibleFields.map(fieldKey => {
                const label = fieldLabels[fieldKey];
                const value = worker[fieldKey] || 'N/A';
                return `<div class="flex justify-between"><span class="text-sm font-medium text-gray-600">${label}:</span><span class="text-sm text-gray-900 text-right">${value}</span></div>`;
            }).join('');
        } else { // 'edit' mode
            dynamicFieldsHtml = visibleFields.map(fieldKey => {
                const fieldLabels = {
                    secteur_name: 'Sector',
                    contract_type: 'Contract Type', 
                    contract_end_date: 'Contract End',
                    model: 'Model',
                    asset_tag: 'Asset Tag',
                    phone_status: 'Phone Status'
                };
                const label = fieldLabels[fieldKey];
                return `<div><label class="custom-label">${label}</label>${createInputField(worker, fieldKey)}</div>`;
            }).join('');
        }

        const viewModeHtml = `
            <div class="card-view">
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center space-x-3"><div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-white font-bold">${worker.worker_name.split(' ').map(n => n[0] || '').join('').substring(0, 2)}</div><div><h3 class="font-semibold text-gray-900">${worker.worker_name}</h3><p class="text-sm text-gray-500">ID: ${worker.worker_id}</p></div></div>
                    <span class="status-badge ${worker.status.toLowerCase()}">${worker.status}</span>
                </div>
                ${getContractWarning(worker)}
                <div class="space-y-2 mb-4">${dynamicFieldsHtml}</div>
                <div class="border-t pt-3 flex justify-end"><button class="btn-secondary btn-sm edit-btn" data-worker-id="${worker.worker_db_id}">Modifier</button></div>
            </div>`;
        
        const editModeHtml = `
            <div class="edit-view hidden">
                <h3 class="font-semibold text-gray-900 mb-3">Modification de ${worker.worker_name}</h3>
                <div class="space-y-3">
                    <div><label class="custom-label">Nom Complet</label><input type="text" name="full_name" class="custom-input" value="${worker.worker_name}"></div>
                    ${dynamicFieldsHtml}
                </div>
                <div class="border-t pt-3 mt-4 flex justify-end space-x-2"><button class="btn-secondary btn-sm cancel-btn" data-worker-id="${worker.worker_db_id}">Annuler</button><button class="btn-primary btn-sm save-btn" data-worker-id="${worker.worker_db_id}">Enregistrer</button></div>
            </div>`;

        return `<div id="worker-card-${worker.worker_db_id}" class="worker-card ${cardBgClass} rounded-lg shadow-md border p-4 transition-shadow">${viewModeHtml}${editModeHtml}</div>`;
    }

    function createInputField(worker, fieldKey) {
        const value = worker[fieldKey] || '';
        
        if (fieldKey === 'secteur_name') {
            const options = sectorsList.map(s => `<option value="${s.id}" ${worker.secteur_id == s.id ? 'selected' : ''}>${s.name}</option>`).join('');
            return `<select name="${fieldKey}" class="custom-select">${options}</select>`;
        }
        
        if (fieldKey === 'contract_type') {
            const options = ['CDI', 'CDD', 'INTERIM'].map(s => `<option value="${s}" ${value === s ? 'selected' : ''}>${s}</option>`).join('');
            return `<select name="${fieldKey}" class="custom-select">${options}</select>`;
        }
        
        if (fieldKey === 'phone_status') {
            const options = ['In Use', 'In Stock', 'Under Repair', 'Decommissioned'].map(s => `<option value="${s}" ${value === s ? 'selected' : ''}>${s}</option>`).join('');
            return `<select name="${fieldKey}" class="custom-select">${options}</select>`;
        }
        
        if (fieldKey === 'contract_end_date') {
            return `<input type="date" name="${fieldKey}" class="custom-input" value="${value}">`;
        }
        
        return `<input type="text" name="${fieldKey}" class="custom-input" value="${value}">`;
    }

    // ======== FILTERS & PAGINATION ========
    function applyFilters() {
        const filters = {
            sector: sectorFilter.value,
            workerStatus: workerStatusFilter.value,
            phoneStatus: phoneStatusFilter.value,
            search: workerSearchFilter.value.toLowerCase()
        };

        return originalWorkersData.filter(w => 
            (!filters.search || w.worker_name.toLowerCase().includes(filters.search)) &&
            (!filters.sector || w.secteur_name === filters.sector) &&
            (!filters.workerStatus || w.status === filters.workerStatus) &&
            (!filters.phoneStatus || w.phone_status === filters.phoneStatus)
        );
    }
    
    // ======== CARD EVENT LISTENERS ========
    workersContainer.addEventListener('click', async e => {
        const workerId = e.target.dataset.workerId;
        if (!workerId) return;
        const card = document.getElementById(`worker-card-${workerId}`);

        if (e.target.matches('.edit-btn')) {
            card.querySelector('.card-view').classList.add('hidden');
            card.querySelector('.edit-view').classList.remove('hidden');
        }
        if (e.target.matches('.cancel-btn')) {
            card.querySelector('.edit-view').classList.add('hidden');
            card.querySelector('.card-view').classList.remove('hidden');
        }
        if (e.target.matches('.save-btn')) {
            const editView = card.querySelector('.edit-view');
            const inputs = editView.querySelectorAll('input, select');
            const updatedData = {};
            inputs.forEach(input => updatedData[input.name] = input.value);
            
            // Rename secteur_name to secteur_id for the backend
            if ('secteur_name' in updatedData) {
                updatedData.secteur_id = updatedData.secteur_name;
                delete updatedData.secteur_name;
            }

            try {
                const response = await fetch(`/api/admin/worker/${workerId}`, {
                    method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(updatedData)
                });
                if (!response.ok) throw new Error((await response.json()).error || 'Failed to save.');
                
                const savedWorker = await response.json();
                const index = originalWorkersData.findIndex(w => w.worker_db_id == workerId);
                if (index !== -1) originalWorkersData[index] = { ...originalWorkersData[index], ...savedWorker };
                
                showToast('Worker updated successfully!');
                updateView(); // Re-render to show updated card and maintain sort/filter order
            } catch (error) {
                showToast(error.message, true);
            }
        }
    });

    // Universal event listeners
    [sectorFilter, workerStatusFilter, phoneStatusFilter].forEach(el => el.addEventListener('change', () => { currentPage = 1; updateView(); }));
    workerSearchFilter.addEventListener('input', () => { currentPage = 1; updateView(); });
    itemsPerPageSelect.addEventListener('change', () => { currentPage = 1; updateView(); });
    paginationControls.addEventListener('click', e => {
        if (e.target.matches('.pagination-btn')) {
            currentPage = parseInt(e.target.dataset.page, 10);
            updateView();
        }
    });

    // ======== HELPER FUNCTIONS ========
    function showToast(message, isError = false) {
        toastMessage.textContent = message;
        toast.className = `toast fixed top-4 right-4 p-4 rounded-md shadow-lg ${isError ? 'error' : 'success'}`;
        toast.classList.remove('hidden');
        setTimeout(() => toast.classList.add('hidden'), 3000);
    }
    
    function getCardBackgroundClass(contractType, endDate) { /* ... same as before ... */ return 'bg-white border-gray-200'; }
    function getContractWarning(worker) { /* ... same as before ... */ return ''; }


    // ======== INITIALIZATION ========
    fetchInitialData();
});
</script>

<style>
    /* Fix for hidden elements */
    .hidden {
        display: none;
    }
    
    /* Add styles for disabled buttons */
    button:disabled { background-color: #d1d5db; cursor: not-allowed; }
    
    /* Status badges */
    .status-badge { padding: 0.25rem 0.65rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; text-transform: capitalize; }
    .status-badge.active { background-color: #d1fae5; color: #065f46; }
    .status-badge.inactive { background-color: #e5e7eb; color: #4b5563; }
    .status-badge.arrêt { background-color: #fee2e2; color: #991b1b; }
    .status-badge.congés { background-color: #fef3c7; color: #92400e; }
    
    /* Toast notifications */
    .toast { transition: opacity 0.3s ease, transform 0.3s ease; }
    .toast.hidden { opacity: 0; transform: translateY(-20px); }
    .toast.success { background-color: #10b981; color: white; }
    .toast.error { background-color: #ef4444; color: white; }
</style>
{% endblock %}