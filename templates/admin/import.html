{% extends "base.html" %}

{% block title %}CSV Import Wizard{% endblock %}

{% block page_title %}CSV Import Wizard{% endblock %}

{% block content %}
<!-- Progress Indicator -->
<div class="custom-card mb-6">
    <div class="grid grid-cols-4 gap-4 text-center">
        <div class="step-indicator active" id="step1-indicator">
            <div class="step-number">1</div>
            <div class="step-label">Upload File</div>
        </div>
        <div class="step-indicator" id="step2-indicator">
            <div class="step-number">2</div>
            <div class="step-label">Preview & Select</div>
        </div>
        <div class="step-indicator" id="step3-indicator">
            <div class="step-number">3</div>
            <div class="step-label">Map Columns</div>
        </div>
        <div class="step-indicator" id="step4-indicator">
            <div class="step-number">4</div>
            <div class="step-label">Import</div>
        </div>
    </div>
</div>

<!-- Step 1: File Upload -->
<div class="custom-card" id="step1-section">
    <h2 class="card-title mb-4">Step 1: Upload CSV File</h2>
    <div class="upload-area border-2 border-dashed border-gray-300 rounded-lg p-8 text-center cursor-pointer hover:border-indigo-500 hover:bg-gray-50 transition-colors" id="upload-area">
        <p class="text-gray-500 mb-4">Select or drag your CSV file here.</p>
        <input type="file" id="csv-file-input" class="hidden" accept=".csv">
        <button type="button" class="btn btn-primary" onclick="document.getElementById('csv-file-input').click()">Choose File</button>
    </div>
    <div class="mt-4 text-center hidden" id="upload-progress">
        <p class="mt-2 text-gray-600">Processing file...</p>
    </div>
</div>

<!-- Step 2: Preview and Table Selection -->
<div class="custom-card hidden" id="step2-section">
    <h2 class="card-title mb-4">Step 2: Preview Data & Select Target Table</h2>
    <div class="mb-4">
        <label for="target-table-select" class="custom-label">Select Target Table:</label>
        <select class="custom-select" id="target-table-select">
            <option value="">-- Choose a table --</option>
        </select>
    </div>
    <h3 class="text-lg font-medium mb-3">Data Preview (First 5 rows):</h3>
    <div class="overflow-x-auto max-h-96">
        <table class="custom-table" id="preview-table">
            <thead id="preview-headers"></thead>
            <tbody id="preview-body"></tbody>
        </table>
    </div>
    <div class="flex justify-between mt-6">
        <button type="button" class="btn btn-secondary" onclick="resetWizard()">Back to Upload</button>
        <button type="button" class="btn btn-primary" id="proceed-to-mapping" disabled>Proceed to Column Mapping</button>
    </div>
</div>

<!-- Step 3: Column Mapping -->
<div class="custom-card hidden" id="step3-section">
    <h2 class="card-title mb-4">Step 3: Map CSV Columns to Database Fields</h2>
    <p class="text-gray-600 mb-4">Map each CSV column to the corresponding database field. Select one column as the merge key for data updates.</p>
    <div class="overflow-x-auto">
        <table class="custom-table">
            <thead>
                <tr>
                    <th>CSV Column</th>
                    <th>Database Column</th>
                    <th>Use as Merge Key</th>
                </tr>
            </thead>
            <tbody id="column-mapping-body"></tbody>
        </table>
    </div>
    <div class="flex justify-between mt-6">
        <button type="button" class="btn btn-secondary" onclick="showStep(2)">Back to Preview</button>
        <button type="button" class="btn btn-primary" id="run-import-btn">Run Import</button>
    </div>
</div>

<!-- Step 4: Import Progress and Results -->
<div class="custom-card hidden" id="step4-section">
    <h2 class="card-title mb-4">Step 4: Import Results</h2>
    <div id="import-progress" class="text-center">
        <p class="mt-4 text-lg text-gray-600">Importing data, please wait...</p>
    </div>
    <div class="hidden" id="import-results"></div>
</div>

<style>
    .step-indicator { position: relative; }
    .step-number { width: 40px; height: 40px; border-radius: 50%; background-color: #6b7280; color: white; display: flex; align-items: center; justify-content: center; margin: 0 auto 10px; font-weight: bold; transition: all 0.3s ease; }
    .step-indicator.active .step-number { background-color: #3b82f6; }
    .step-indicator.completed .step-number { background-color: #10b981; }
    .step-label { font-size: 0.9em; color: #6b7280; }
    .step-indicator.active .step-label { color: #3b82f6; font-weight: bold; }
    .step-indicator.completed .step-label { color: #10b981; }
</style>
{% endblock %}

{% block scripts %}
<script>
    let csvData = '';
    let csvHeaders = [];
    let selectedTable = '';
    let dbColumns = [];

    document.addEventListener('DOMContentLoaded', function() {
        const fileInput = document.getElementById('csv-file-input');
        const uploadArea = document.getElementById('upload-area');

        fileInput.addEventListener('change', e => handleFileUpload(e.target.files[0]));
        uploadArea.addEventListener('dragover', e => { e.preventDefault(); uploadArea.classList.add('border-indigo-500'); });
        uploadArea.addEventListener('dragleave', e => { e.preventDefault(); uploadArea.classList.remove('border-indigo-500'); });
        uploadArea.addEventListener('drop', e => {
            e.preventDefault();
            uploadArea.classList.remove('border-indigo-500');
            handleFileUpload(e.dataTransfer.files[0]);
        });

        document.getElementById('target-table-select').addEventListener('change', handleTableSelection);
        document.getElementById('proceed-to-mapping').addEventListener('click', () => showStep(3));
        document.getElementById('run-import-btn').addEventListener('click', executeImport);
    });

    function showStep(stepNumber) {
        document.querySelectorAll('[id^="step"]').forEach(el => el.classList.add('hidden'));
        document.getElementById(`step${stepNumber}-section`).classList.remove('hidden');
        document.querySelectorAll('.step-indicator').forEach((indicator, index) => {
            indicator.classList.remove('active', 'completed');
            if (index + 1 === stepNumber) indicator.classList.add('active');
            else if (index + 1 < stepNumber) indicator.classList.add('completed');
        });
    }

    function resetWizard() {
        csvData = '';
        csvHeaders = [];
        selectedTable = '';
        dbColumns = [];
        document.getElementById('csv-file-input').value = '';
        showStep(1);
    }

    async function handleFileUpload(file) {
        if (!file) return;
        document.getElementById('upload-progress').classList.remove('hidden');
        const formData = new FormData();
        formData.append('file', file);

        try {
            const response = await fetch('/api/import/preview', { method: 'POST', body: formData });
            const data = await response.json();
            if (!response.ok) throw new Error(data.error);

            const reader = new FileReader();
            reader.onload = function(e) {
                csvData = e.target.result;
                csvHeaders = data.headers;
                populatePreviewTable(data.preview_data);
                populateTableSelect(data.tables);
                showStep(2);
            };
            reader.readAsText(file);
        } catch (error) {
            alert(`Error: ${error.message}`);
        } finally {
            document.getElementById('upload-progress').classList.add('hidden');
        }
    }

    function populatePreviewTable(previewData) {
        const headersRow = document.getElementById('preview-headers');
        const bodyElement = document.getElementById('preview-body');
        headersRow.innerHTML = `<tr>${csvHeaders.map(h => `<th>${h}</th>`).join('')}</tr>`;
        bodyElement.innerHTML = previewData.map(row => `<tr>${csvHeaders.map(h => `<td>${row[h] || ''}</td>`).join('')}</tr>`).join('');
    }

    function populateTableSelect(tables) {
        const select = document.getElementById('target-table-select');
        select.innerHTML = '<option value="">-- Choose a table --</option>';
        tables.forEach(table => select.innerHTML += `<option value="${table}">${table}</option>`);
    }

    async function handleTableSelection() {
        selectedTable = this.value;
        const proceedBtn = document.getElementById('proceed-to-mapping');
        if (!selectedTable) {
            proceedBtn.disabled = true;
            return;
        }
        try {
            const response = await fetch('/api/import/schema', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ table_name: selectedTable })
            });
            const data = await response.json();
            if (!response.ok) throw new Error(data.error);
            dbColumns = data.columns;
            setupColumnMapping();
            proceedBtn.disabled = false;
        } catch (error) {
            alert(`Error fetching schema: ${error.message}`);
            proceedBtn.disabled = true;
        }
    }

    function setupColumnMapping() {
        const tbody = document.getElementById('column-mapping-body');
        tbody.innerHTML = '';
        csvHeaders.forEach((csvHeader, index) => {
            const dbOptions = dbColumns.map(col => `<option value="${col}" ${csvHeader.toLowerCase() === col.toLowerCase() ? 'selected' : ''}>${col}</option>`).join('');
            const row = `
                <tr>
                    <td>${csvHeader}</td>
                    <td><select class="custom-select" id="db-column-${index}"><option value="">Do not import</option>${dbOptions}</select></td>
                    <td><input type="radio" name="merge-key" value="${csvHeader}" class="w-4 h-4 text-indigo-600" ${index === 0 ? 'checked' : ''}></td>
                </tr>`;
            tbody.insertAdjacentHTML('beforeend', row);
        });
    }

    async function executeImport() {
        const mergeKeyCsv = document.querySelector('input[name="merge-key"]:checked').value;
        const columnMappings = {};
        let mergeKeyDb = '';

        csvHeaders.forEach((csvHeader, index) => {
            const dbSelect = document.getElementById(`db-column-${index}`);
            if (dbSelect.value) columnMappings[csvHeader] = dbSelect.value;
            if (csvHeader === mergeKeyCsv) mergeKeyDb = dbSelect.value;
        });

        if (!mergeKeyDb) {
            alert('The selected merge key must be mapped to a database column.');
            return;
        }

        showStep(4);
        const resultsDiv = document.getElementById('import-results');
        resultsDiv.classList.add('hidden');
        document.getElementById('import-progress').classList.remove('hidden');

        try {
            const response = await fetch('/api/import/process', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ csv_data: csvData, target_table: selectedTable, merge_key_csv: mergeKeyCsv, merge_key_db: mergeKeyDb, column_mappings: columnMappings })
            });
            const result = await response.json();
            if (!response.ok) throw new Error(result.error);
            
            resultsDiv.innerHTML = `<p class="text-green-700">${result.message}</p><p>Inserted: ${result.inserted}, Updated: ${result.updated}</p><button class="btn btn-secondary mt-4" onclick="resetWizard()">Import Another File</button>`;
        } catch (error) {
            resultsDiv.innerHTML = `<p class="text-red-700">Error: ${error.message}</p><button class="btn btn-secondary mt-4" onclick="showStep(3)">Go Back</button>`;
        } finally {
            document.getElementById('import-progress').classList.add('hidden');
            resultsDiv.classList.remove('hidden');
        }
    }
</script>
{% endblock %}
