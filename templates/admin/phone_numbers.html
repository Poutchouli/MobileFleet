{% extends "base.html" %}

{% block title %}Phone Numbers - Admin{% endblock %}

{% block page_title %}Phone Numbers Management{% endblock %}

{% block content %}
<div class="custom-card">
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-xl font-semibold">Phone Numbers</h2>
        <button id="add-phone-number-btn" class="btn btn-primary">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
            </svg>
            Add Phone Number
        </button>
    </div>
    
    <!-- Search and Filter -->
    <div class="flex flex-col md:flex-row gap-4 mb-4">
        <div class="flex-1">
            <label for="search-input" class="custom-label">Search Phone Numbers</label>
            <input type="text" id="search-input" placeholder="Search by phone number, SIM ICCID, or worker name..." class="custom-input">
        </div>
        <div class="w-full md:w-48">
            <label for="status-filter" class="custom-label">Filter by Status</label>
            <select id="status-filter" class="custom-input">
                <option value="">All Status</option>
                <option value="Active">Active</option>
                <option value="Inactive">Inactive</option>
            </select>
        </div>
        <div class="w-full md:w-48">
            <label for="assignment-filter" class="custom-label">Filter by Assignment</label>
            <select id="assignment-filter" class="custom-input">
                <option value="">All</option>
                <option value="Assigned">Assigned</option>
                <option value="Available">Available</option>
                <option value="Unassigned">Unassigned</option>
            </select>
        </div>
    </div>
    
    <!-- Phone Numbers Table -->
    <div class="overflow-x-auto">
        <table class="custom-table">
            <thead>
                <tr>
                    <th>Phone Number</th>
                    <th>Status</th>
                    <th>SIM ICCID</th>
                    <th>Carrier</th>
                    <th>Assignment Status</th>
                    <th>Assigned to Worker</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="phone-numbers-table-body">
                <!-- Data will be populated by JavaScript -->
            </tbody>
        </table>
    </div>
</div>

<!-- Phone Number Modal -->
<div id="phone-number-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <h3 class="text-lg font-medium text-gray-900 mb-4" id="modal-title">Add Phone Number</h3>
            <form id="phone-number-form">
                <div class="mb-4">
                    <label for="phone-number-input" class="custom-label">Phone Number *</label>
                    <input type="tel" id="phone-number-input" class="custom-input" required>
                </div>
                <div class="mb-4">
                    <label for="sim-card-select" class="custom-label">SIM Card (Optional)</label>
                    <select id="sim-card-select" class="custom-input">
                        <option value="">Select SIM Card</option>
                        <!-- Options will be populated by JavaScript -->
                    </select>
                </div>
                <div class="mb-4">
                    <label for="status-select" class="custom-label">Status</label>
                    <select id="status-select" class="custom-input">
                        <option value="Active">Active</option>
                        <option value="Inactive">Inactive</option>
                    </select>
                </div>
                <div class="flex justify-end gap-2">
                    <button type="button" id="cancel-phone-number-btn" class="btn btn-secondary">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <span id="submit-btn-text">Add Phone Number</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let phoneNumbers = [];
    let simCards = [];
    let editingPhoneNumberId = null;

    document.addEventListener('DOMContentLoaded', function() {
        loadPhoneNumbers();
        loadSimCards();
        setupEventListeners();
    });

    function setupEventListeners() {
        // Add phone number button
        document.getElementById('add-phone-number-btn').addEventListener('click', () => {
            openPhoneNumberModal();
        });

        // Cancel button
        document.getElementById('cancel-phone-number-btn').addEventListener('click', () => {
            closePhoneNumberModal();
        });

        // Form submission
        document.getElementById('phone-number-form').addEventListener('submit', handlePhoneNumberSubmit);

        // Search and filters
        document.getElementById('search-input').addEventListener('input', filterPhoneNumbers);
        document.getElementById('status-filter').addEventListener('change', filterPhoneNumbers);
        document.getElementById('assignment-filter').addEventListener('change', filterPhoneNumbers);

        // Close modal when clicking outside
        document.getElementById('phone-number-modal').addEventListener('click', (e) => {
            if (e.target.id === 'phone-number-modal') {
                closePhoneNumberModal();
            }
        });
    }

    async function loadPhoneNumbers() {
        try {
            const response = await fetch('/api/phone-numbers');
            if (!response.ok) throw new Error('Failed to load phone numbers');
            phoneNumbers = await response.json();
            renderPhoneNumbers();
        } catch (error) {
            console.error('Error loading phone numbers:', error);
            showNotification('Error loading phone numbers', 'error');
        }
    }

    async function loadSimCards() {
        try {
            const response = await fetch('/api/sims');
            if (!response.ok) throw new Error('Failed to load SIM cards');
            simCards = await response.json();
            populateSimCardSelect();
        } catch (error) {
            console.error('Error loading SIM cards:', error);
        }
    }

    function populateSimCardSelect() {
        const select = document.getElementById('sim-card-select');
        select.innerHTML = '<option value="">Select SIM Card</option>';
        
        simCards.forEach(sim => {
            const option = document.createElement('option');
            option.value = sim.id;
            option.textContent = `${sim.iccid} (${sim.carrier})${sim.phone_number ? ' - ' + sim.phone_number : ''}`;
            select.appendChild(option);
        });
    }

    function renderPhoneNumbers() {
        const tbody = document.getElementById('phone-numbers-table-body');
        tbody.innerHTML = '';

        const filteredNumbers = filterPhoneNumbersData();

        filteredNumbers.forEach(phoneNumber => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="font-mono font-medium">${phoneNumber.phone_number}</td>
                <td>
                    <span class="inline-block px-2 py-1 text-xs rounded-full ${
                        phoneNumber.status === 'Active' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                    }">
                        ${phoneNumber.status}
                    </span>
                </td>
                <td class="font-mono text-sm">${phoneNumber.iccid || 'N/A'}</td>
                <td>${phoneNumber.carrier || 'N/A'}</td>
                <td>
                    <span class="inline-block px-2 py-1 text-xs rounded-full ${
                        phoneNumber.assignment_status === 'Assigned' ? 'bg-blue-100 text-blue-800' :
                        phoneNumber.assignment_status === 'Available' ? 'bg-yellow-100 text-yellow-800' :
                        'bg-gray-100 text-gray-800'
                    }">
                        ${phoneNumber.assignment_status}
                    </span>
                </td>
                <td>${phoneNumber.assigned_to_worker || 'N/A'}</td>
                <td>
                    <div class="flex gap-2">
                        <button onclick="editPhoneNumber(${phoneNumber.id})" class="text-blue-600 hover:text-blue-800">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                            </svg>
                        </button>
                        <button onclick="deletePhoneNumber(${phoneNumber.id}, '${phoneNumber.phone_number}')" class="text-red-600 hover:text-red-800">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                    </div>
                </td>
            `;
            tbody.appendChild(row);
        });
    }

    function filterPhoneNumbersData() {
        const searchTerm = document.getElementById('search-input').value.toLowerCase();
        const statusFilter = document.getElementById('status-filter').value;
        const assignmentFilter = document.getElementById('assignment-filter').value;

        return phoneNumbers.filter(phoneNumber => {
            const matchesSearch = !searchTerm || 
                phoneNumber.phone_number.toLowerCase().includes(searchTerm) ||
                (phoneNumber.iccid && phoneNumber.iccid.toLowerCase().includes(searchTerm)) ||
                (phoneNumber.assigned_to_worker && phoneNumber.assigned_to_worker.toLowerCase().includes(searchTerm));

            const matchesStatus = !statusFilter || phoneNumber.status === statusFilter;
            const matchesAssignment = !assignmentFilter || phoneNumber.assignment_status === assignmentFilter;

            return matchesSearch && matchesStatus && matchesAssignment;
        });
    }

    function filterPhoneNumbers() {
        renderPhoneNumbers();
    }

    function openPhoneNumberModal(phoneNumber = null) {
        editingPhoneNumberId = phoneNumber ? phoneNumber.id : null;
        const modal = document.getElementById('phone-number-modal');
        const form = document.getElementById('phone-number-form');
        
        if (phoneNumber) {
            document.getElementById('modal-title').textContent = 'Edit Phone Number';
            document.getElementById('submit-btn-text').textContent = 'Update Phone Number';
            document.getElementById('phone-number-input').value = phoneNumber.phone_number;
            document.getElementById('sim-card-select').value = phoneNumber.sim_id || '';
            document.getElementById('status-select').value = phoneNumber.status;
        } else {
            document.getElementById('modal-title').textContent = 'Add Phone Number';
            document.getElementById('submit-btn-text').textContent = 'Add Phone Number';
            form.reset();
        }
        
        modal.classList.remove('hidden');
    }

    function closePhoneNumberModal() {
        document.getElementById('phone-number-modal').classList.add('hidden');
        document.getElementById('phone-number-form').reset();
        editingPhoneNumberId = null;
    }

    async function handlePhoneNumberSubmit(e) {
        e.preventDefault();
        
        const formData = {
            phone_number: document.getElementById('phone-number-input').value,
            sim_card_id: document.getElementById('sim-card-select').value || null,
            status: document.getElementById('status-select').value
        };

        try {
            const url = editingPhoneNumberId ? `/api/phone-numbers/${editingPhoneNumberId}` : '/api/phone-numbers';
            const method = editingPhoneNumberId ? 'PUT' : 'POST';
            
            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Failed to save phone number');
            }

            const result = await response.json();
            showNotification(editingPhoneNumberId ? 'Phone number updated successfully' : 'Phone number added successfully', 'success');
            closePhoneNumberModal();
            loadPhoneNumbers();
        } catch (error) {
            console.error('Error saving phone number:', error);
            showNotification(error.message, 'error');
        }
    }

    function editPhoneNumber(id) {
        const phoneNumber = phoneNumbers.find(p => p.id === id);
        if (phoneNumber) {
            openPhoneNumberModal(phoneNumber);
        }
    }

    async function deletePhoneNumber(id, phoneNumber) {
        if (!confirm(`Are you sure you want to deactivate phone number ${phoneNumber}?`)) {
            return;
        }

        try {
            const response = await fetch(`/api/phone-numbers/${id}`, {
                method: 'DELETE'
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Failed to delete phone number');
            }

            showNotification('Phone number deactivated successfully', 'success');
            loadPhoneNumbers();
        } catch (error) {
            console.error('Error deleting phone number:', error);
            showNotification(error.message, 'error');
        }
    }

    function showNotification(message, type) {
        // Simple notification system - you can enhance this
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 p-4 rounded-md ${
            type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
        } z-50`;
        notification.textContent = message;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.remove();
        }, 3000);
    }
</script>
{% endblock %}
