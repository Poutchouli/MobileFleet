{% extends "base.html" %}

{% block title %}Flotte Télégestion - Admin{% endblock %}

{% block page_title %}Flotte Télégestion{% endblock %}

{% block content %}
<!-- Fleet Navigation -->
<div class="mb-6">
    <div class="border-b border-gray-200">
        <nav class="-mb-px flex">
            <button id="phones-tab" class="tab-button active" data-tab="phones">
                {{ _('Phones') }}
            </button>
            <button id="sims-tab" class="tab-button" data-tab="sims">
                {{ _('SIM Cards') }}
            </button>
            <button id="phone-numbers-tab" class="tab-button" data-tab="phone-numbers">
                {{ _('Phone Numbers') }}
            </button>
            <button id="workers-tab" class="tab-button" data-tab="workers">
                {{ _('Workers') }}
            </button>
        </nav>
    </div>
</div>

<!-- Phones Tab -->
<div id="phones-panel" class="tab-panel active">
    <div class="custom-card">
        <div class="card-header">
            <h2 class="card-title">{{ _('Phone Management') }}</h2>
            <button id="add-phone-btn" class="btn-primary">{{ _('Add New Phone') }}</button>
        </div>
        <div class="p-4">
            <div class="overflow-x-auto">
                <table id="phones-table" class="custom-table w-full">
                    <thead>
                        <tr>
                            <th>{{ _('Asset Tag') }}</th>
                            <th>{{ _('IMEI') }}</th>
                            <th>{{ _('Manufacturer') }}</th>
                            <th>{{ _('Model') }}</th>
                            <th>{{ _('Status') }}</th>
                            <th>{{ _('Actions') }}</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Data loaded dynamically -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- SIM Cards Tab -->
<div id="sims-panel" class="tab-panel">
    <div class="custom-card">
        <div class="card-header">
            <h2 class="card-title">{{ _('SIM Card Management') }}</h2>
            <button id="add-sim-btn" class="btn-primary">{{ _('Add New SIM') }}</button>
        </div>
        <div class="p-4">
            <div class="overflow-x-auto">
                <table id="sims-table" class="custom-table w-full">
                    <thead>
                        <tr>
                            <th>{{ _('ICCID') }}</th>
                            <th>{{ _('Carrier') }}</th>
                            <th>{{ _('Phone Number') }}</th>
                            <th>{{ _('Status') }}</th>
                            <th>{{ _('Actions') }}</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Data loaded dynamically -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Phone Numbers Tab -->
<div id="phone-numbers-panel" class="tab-panel">
    <div class="custom-card">
        <div class="card-header">
            <h2 class="card-title">{{ _('Phone Numbers Management') }}</h2>
            <button id="add-phone-number-btn" class="btn-primary">{{ _('Add New Number') }}</button>
        </div>
        <div class="p-4">
            <div class="overflow-x-auto">
                <table id="phone-numbers-table" class="custom-table w-full">
                    <thead>
                        <tr>
                            <th>{{ _('Phone Number') }}</th>
                            <th>{{ _('SIM ICCID') }}</th>
                            <th>{{ _('Carrier') }}</th>
                            <th>{{ _('Assignment Status') }}</th>
                            <th>{{ _('Assigned To') }}</th>
                            <th>{{ _('Actions') }}</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Data loaded dynamically -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Workers Tab -->
<div id="workers-panel" class="tab-panel">
    <div class="custom-card">
        <div class="card-header">
            <h2 class="card-title">{{ _('Workers Management') }}</h2>
            <button id="add-worker-btn" class="btn-primary">{{ _('Add New Worker') }}</button>
        </div>
        <div class="p-4">
            <div class="overflow-x-auto">
                <table id="workers-table" class="custom-table w-full">
                    <thead>
                        <tr>
                            <th>{{ _('Worker ID') }}</th>
                            <th>{{ _('Full Name') }}</th>
                            <th>{{ _('Sector') }}</th>
                            <th>{{ _('Status') }}</th>
                            <th>{{ _('Actions') }}</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Data loaded dynamically -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modals will be loaded dynamically here -->
<div id="modal-container"></div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Tab switching functionality
        function initTabs() {
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabPanels = document.querySelectorAll('.tab-panel');

            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const targetTab = button.dataset.tab;

                    // Remove active class from all buttons and panels
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabPanels.forEach(panel => panel.classList.remove('active'));

                    // Add active class to clicked button and corresponding panel
                    button.classList.add('active');
                    document.getElementById(`${targetTab}-panel`).classList.add('active');

                    // Load data for the active tab if not already loaded
                    loadTabData(targetTab);
                });
            });
        }

        // Data loading functions
        let loadedTabs = new Set();

        function loadTabData(tabName) {
            if (loadedTabs.has(tabName)) return;

            switch(tabName) {
                case 'phones':
                    loadPhonesData();
                    break;
                case 'sims':
                    loadSimsData();
                    break;
                case 'phone-numbers':
                    loadPhoneNumbersData();
                    break;
                case 'workers':
                    loadWorkersData();
                    break;
            }
            
            loadedTabs.add(tabName);
        }

        // Phones functionality
        async function loadPhonesData() {
            try {
                const response = await fetch('/api/phones');
                const phones = await response.json();
                renderPhonesTable(phones);
            } catch (error) {
                console.error('Error loading phones:', error);
                showError('Failed to load phones data');
            }
        }

        function renderPhonesTable(phones) {
            const tbody = document.querySelector('#phones-table tbody');
            tbody.innerHTML = '';

            phones.forEach(phone => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-4 py-3">${phone.asset_tag}</td>
                    <td class="px-4 py-3">${phone.imei}</td>
                    <td class="px-4 py-3">${phone.manufacturer || '-'}</td>
                    <td class="px-4 py-3">${phone.model || '-'}</td>
                    <td class="px-4 py-3">
                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full 
                            ${getStatusColor(phone.status)}">${phone.status}</span>
                    </td>
                    <td class="px-4 py-3">
                        <button onclick="editPhone(${phone.id})" class="btn-secondary btn-sm mr-2">{{ _('Edit') }}</button>
                        <button onclick="deletePhone(${phone.id})" class="btn-danger btn-sm">{{ _('Delete') }}</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // SIM Cards functionality
        async function loadSimsData() {
            try {
                const response = await fetch('/api/sims');
                const sims = await response.json();
                renderSimsTable(sims);
            } catch (error) {
                console.error('Error loading SIMs:', error);
                showError('Failed to load SIM cards data');
            }
        }

        function renderSimsTable(sims) {
            const tbody = document.querySelector('#sims-table tbody');
            tbody.innerHTML = '';

            sims.forEach(sim => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-4 py-3">${sim.iccid}</td>
                    <td class="px-4 py-3">${sim.carrier || '-'}</td>
                    <td class="px-4 py-3">${sim.phone_number || '-'}</td>
                    <td class="px-4 py-3">
                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full 
                            ${getStatusColor(sim.status)}">${sim.status}</span>
                    </td>
                    <td class="px-4 py-3">
                        <button onclick="editSim(${sim.id})" class="btn-secondary btn-sm mr-2">{{ _('Edit') }}</button>
                        <button onclick="deleteSim(${sim.id})" class="btn-danger btn-sm">{{ _('Delete') }}</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Phone Numbers functionality
        async function loadPhoneNumbersData() {
            try {
                const response = await fetch('/api/phone-numbers');
                const numbers = await response.json();
                renderPhoneNumbersTable(numbers);
            } catch (error) {
                console.error('Error loading phone numbers:', error);
                showError('Failed to load phone numbers data');
            }
        }

        function renderPhoneNumbersTable(numbers) {
            const tbody = document.querySelector('#phone-numbers-table tbody');
            tbody.innerHTML = '';

            numbers.forEach(number => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-4 py-3">${number.phone_number}</td>
                    <td class="px-4 py-3">${number.iccid || '-'}</td>
                    <td class="px-4 py-3">${number.carrier || '-'}</td>
                    <td class="px-4 py-3">
                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full 
                            ${getAssignmentStatusColor(number.assignment_status)}">${number.assignment_status}</span>
                    </td>
                    <td class="px-4 py-3">${number.assigned_to_worker || '-'}</td>
                    <td class="px-4 py-3">
                        <button onclick="editPhoneNumber(${number.id})" class="btn-secondary btn-sm mr-2">{{ _('Edit') }}</button>
                        <button onclick="deletePhoneNumber(${number.id})" class="btn-danger btn-sm">{{ _('Delete') }}</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Workers functionality
        async function loadWorkersData() {
            try {
                const response = await fetch('/api/workers');
                const workers = await response.json();
                renderWorkersTable(workers);
            } catch (error) {
                console.error('Error loading workers:', error);
                showError('Failed to load workers data');
            }
        }

        function renderWorkersTable(workers) {
            const tbody = document.querySelector('#workers-table tbody');
            tbody.innerHTML = '';

            workers.forEach(worker => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-4 py-3">${worker.worker_id}</td>
                    <td class="px-4 py-3">${worker.full_name}</td>
                    <td class="px-4 py-3">${worker.secteur_name || '-'}</td>
                    <td class="px-4 py-3">
                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full 
                            ${getStatusColor(worker.status)}">${worker.status}</span>
                    </td>
                    <td class="px-4 py-3">
                        <button onclick="editWorker(${worker.id})" class="btn-secondary btn-sm mr-2">{{ _('Edit') }}</button>
                        <button onclick="deleteWorker(${worker.id})" class="btn-danger btn-sm">{{ _('Delete') }}</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Utility functions
        function getStatusColor(status) {
            switch(status) {
                case 'In Stock': case 'Active':
                    return 'bg-green-100 text-green-800';
                case 'In Use':
                    return 'bg-blue-100 text-blue-800';
                case 'Maintenance':
                    return 'bg-yellow-100 text-yellow-800';
                case 'Retired': case 'Inactive':
                    return 'bg-red-100 text-red-800';
                default:
                    return 'bg-gray-100 text-gray-800';
            }
        }

        function getAssignmentStatusColor(status) {
            switch(status) {
                case 'Assigned':
                    return 'bg-blue-100 text-blue-800';
                case 'Available':
                    return 'bg-green-100 text-green-800';
                case 'Unassigned':
                    return 'bg-gray-100 text-gray-800';
                default:
                    return 'bg-gray-100 text-gray-800';
            }
        }

        function showError(message) {
            // Simple error display - you can enhance this
            console.error(message);
            alert(message);
        }

        // Action functions (to be implemented)
        window.editPhone = function(id) {
            window.location.href = `/admin/phones?edit=${id}`;
        };

        window.deletePhone = function(id) {
            if (confirm('Are you sure you want to delete this phone?')) {
                // Implement delete functionality
            }
        };

        window.editSim = function(id) {
            window.location.href = `/admin/sims?edit=${id}`;
        };

        window.deleteSim = function(id) {
            if (confirm('Are you sure you want to delete this SIM card?')) {
                // Implement delete functionality
            }
        };

        window.editPhoneNumber = function(id) {
            window.location.href = `/admin/phone-numbers?edit=${id}`;
        };

        window.deletePhoneNumber = function(id) {
            if (confirm('Are you sure you want to delete this phone number?')) {
                // Implement delete functionality
            }
        };

        window.editWorker = function(id) {
            window.location.href = `/admin/workers?edit=${id}`;
        };

        window.deleteWorker = function(id) {
            if (confirm('Are you sure you want to delete this worker?')) {
                // Implement delete functionality
            }
        };

        // Add button functionality
        document.getElementById('add-phone-btn').addEventListener('click', () => {
            window.location.href = '/admin/phones?add=true';
        });

        document.getElementById('add-sim-btn').addEventListener('click', () => {
            window.location.href = '/admin/sims?add=true';
        });

        document.getElementById('add-phone-number-btn').addEventListener('click', () => {
            window.location.href = '/admin/phone-numbers?add=true';
        });

        document.getElementById('add-worker-btn').addEventListener('click', () => {
            window.location.href = '/admin/workers?add=true';
        });

        // Initialize
        initTabs();
        loadTabData('phones'); // Load initial tab data
    });
</script>

<style>
    .tab-button {
        padding: 0.5rem 1rem;
        border-bottom: 2px solid transparent;
        font-weight: 500;
        font-size: 0.875rem;
        cursor: pointer;
        color: #6b7280;
        transition: all 0.2s ease;
        border: none;
        background: none;
    }

    .tab-button.active {
        color: #2563eb;
        border-color: #2563eb;
    }

    .tab-button:hover:not(.active) {
        color: #6b7280;
        border-color: #d1d5db;
    }

    .tab-panel {
        display: none;
    }

    .tab-panel.active {
        display: block;
    }

    .btn-sm {
        padding: 0.375rem 0.75rem;
        font-size: 0.75rem;
    }
</style>
{% endblock %}
