<!DOCTYPE html>
<html>
<head>
    <title>Admin - Enhanced CSV Import</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 40px auto; 
            max-width: 600px; 
            background: #f5f5f5; 
        }
        .container { 
            background: white; 
            padding: 30px; 
            border-radius: 8px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
        }
        h1 { 
            color: #333; 
            text-align: center; 
            margin-bottom: 30px; 
        }
        .upload-area { 
            border: 2px dashed #007bff; 
            border-radius: 8px; 
            padding: 40px; 
            text-align: center; 
            margin-bottom: 20px; 
            background: #f8f9fa; 
        }
        .upload-area:hover { 
            background: #e9ecef; 
        }
        input[type="file"] { 
            margin: 15px 0; 
            padding: 10px; 
        }
        .import-btn { 
            background: #28a745; 
            color: white; 
            padding: 15px 30px; 
            border: none; 
            border-radius: 5px; 
            font-size: 16px; 
            cursor: pointer; 
            width: 100%; 
            margin-top: 15px; 
        }
        .import-btn:hover { 
            background: #218838; 
        }
        .import-btn:disabled { 
            background: #6c757d; 
            cursor: not-allowed; 
        }
        .result { 
            margin-top: 20px; 
            padding: 15px; 
            border-radius: 5px; 
            display: none; 
        }
        .success { 
            background: #d4edda; 
            border: 1px solid #c3e6cb; 
            color: #155724; 
        }
        .error { 
            background: #f8d7da; 
            border: 1px solid #f5c6cb; 
            color: #721c24; 
        }
        .info { 
            background: #d1ecf1; 
            border: 1px solid #bee5eb; 
            color: #0c5460; 
            padding: 15px; 
            border-radius: 5px; 
            margin-bottom: 20px; 
        }
        .loading { 
            text-align: center; 
            color: #007bff; 
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Enhanced CSV Import</h1>
        
        <div class="info">
            <strong>üöÄ Enhanced Import:</strong> Workers, SIM Cards, Phone Numbers, and Phones with full relationships<br>
            <strong>üìä Supported formats:</strong> Semicolon (;), Comma (,), or Tab-separated with UTF-8/ISO encoding<br>
            <strong>üìã Expected headers:</strong> Num SAL, Nom, Domaine d'Intervention, Contrat, Date Dernier contrat, N¬∞ SIM, OP, PUK, NUMERO, RIO, IMEI T√©l√©phone (*#06#), Mat√®riel<br>
            <strong>‚ö° Performance:</strong> Batch processing with detailed error reporting and recovery
        </div>
        
        <form id="importForm">
            <div class="upload-area">
                <h3>üìÅ Select CSV File</h3>
                <input type="file" id="csvFile" accept=".csv,.txt" required>
                <p>Choose your CSV file to import all data with automatic relationship creation</p>
                
                <!-- Advanced Options (Collapsible) -->
                <div style="margin-top: 20px; text-align: left;">
                    <details>
                        <summary style="cursor: pointer; font-weight: bold; color: #007bff;">‚öôÔ∏è Advanced Options</summary>
                        <div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 5px;">
                            <div style="margin-bottom: 10px;">
                                <label><strong>Delimiter:</strong></label><br>
                                <label><input type="radio" name="delimiter" value=";" checked> Semicolon (;)</label>
                                <label style="margin-left: 15px;"><input type="radio" name="delimiter" value=","> Comma (,)</label>
                                <label style="margin-left: 15px;"><input type="radio" name="delimiter" value="tab"> Tab</label>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <label><strong>Encoding:</strong></label><br>
                                <select id="encoding" style="padding: 5px;">
                                    <option value="utf-8">UTF-8 (Recommended)</option>
                                    <option value="iso-8859-1">ISO-8859-1 (Western European)</option>
                                    <option value="windows-1252">Windows-1252</option>
                                </select>
                            </div>
                            <div>
                                <label><input type="checkbox" id="skipErrors" checked> Continue processing on row errors</label><br>
                                <label><input type="checkbox" id="createMissing" checked> Auto-create missing secteurs</label><br>
                                <label><input type="checkbox" id="updateExisting" checked> Update existing records</label>
                            </div>
                        </div>
                    </details>
                </div>
            </div>
            
            <button type="submit" class="import-btn" id="importBtn">
                üöÄ Import CSV Data
            </button>
        </form>
        
        <div id="result" class="result"></div>
    </div>

    <script>
        document.getElementById('importForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const fileInput = document.getElementById('csvFile');
            const importBtn = document.getElementById('importBtn');
            const resultDiv = document.getElementById('result');
            
            if (!fileInput.files[0]) {
                alert('Please select a CSV file');
                return;
            }
            
            // Disable button and show loading
            importBtn.disabled = true;
            importBtn.textContent = 'üîÑ Processing...';
            resultDiv.style.display = 'block';
            resultDiv.className = 'result loading';
            resultDiv.innerHTML = 'üîÑ Analyzing CSV structure and processing data...<br><small>This may take a few minutes for large files</small>';
            
            // Get user-selected options
            const selectedDelimiter = document.querySelector('input[name="delimiter"]:checked').value;
            const delimiter = selectedDelimiter === 'tab' ? '\t' : selectedDelimiter;
            const encoding = document.getElementById('encoding').value;
            const skipErrors = document.getElementById('skipErrors').checked;
            const createMissing = document.getElementById('createMissing').checked;
            const updateExisting = document.getElementById('updateExisting').checked;
            
            // Prepare form data with user configurations
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('encoding', encoding);
            formData.append('delimiter', delimiter);
            formData.append('skip_errors', skipErrors);
            formData.append('create_missing', createMissing);
            formData.append('update_existing', updateExisting);
            
            // Pre-configured column mappings for the enhanced import
            const columnMappings = {
                "worker_id": "Num SAL",
                "full_name": "Nom", 
                "secteur_name": "Domaine d'Intervention",
                "contract_type": "Contrat",
                "last_contract_date": "Date Dernier contrat",
                "iccid": "N¬∞ SIM",
                "carrier": "OP",
                "puk": "PUK",
                "phone_number": "NUMERO",
                "rio": "RIO",
                "imei": "IMEI T√©l√©phone (*#06#)",
                "model": "Mat√®riel"
            };
            
            formData.append('column_mappings', JSON.stringify(columnMappings));
            
            // Send the import request
            fetch('/api/import/process', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                // Re-enable button
                importBtn.disabled = false;
                importBtn.textContent = 'üöÄ Import CSV Data';
                
                if (data.error) {
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = `
                        <strong>‚ùå Import Failed</strong><br>
                        ${data.error}
                        ${data.details ? '<br><br><strong>Technical Details:</strong><br>' + data.details : ''}
                    `;
                } else {
                    resultDiv.className = 'result success';
                    let resultHtml = `
                        <strong>‚úÖ Import Completed!</strong><br><br>
                        <strong>üìä Processing Summary:</strong><br>
                        ‚Ä¢ <span style="color: #28a745; font-weight: bold;">${data.inserted || 0}</span> new records created<br>
                        ‚Ä¢ <span style="color: #17a2b8; font-weight: bold;">${data.updated || 0}</span> existing records updated<br>
                        ‚Ä¢ <span style="color: #dc3545; font-weight: bold;">${data.errors || 0}</span> errors encountered<br><br>
                        <em>${data.message}</em>
                    `;
                    
                    // Enhanced error reporting with better formatting
                    if (data.error_details && data.error_details.length > 0) {
                        const errorCount = data.error_details.length;
                        const totalErrors = data.errors || 0;
                        
                        resultHtml += `<br><br><strong>üîç Error Analysis (${errorCount}${totalErrors > errorCount ? `/${totalErrors}` : ''} shown):</strong><br>`;
                        resultHtml += `<div style="max-height: 400px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; background: #f8f9fa; border-radius: 5px;">`;
                        
                        data.error_details.forEach((error, index) => {
                            const errorType = error.error.includes('duplicate') ? 'üîÑ Duplicate' : 
                                            error.error.includes('constraint') ? '‚ö†Ô∏è Constraint' : 
                                            error.error.includes('null') ? '‚ùå Missing Data' : 'üêõ Other';
                            
                            resultHtml += `
                                <div style="margin-bottom: 12px; padding: 12px; background: white; border-left: 4px solid #dc3545; border-radius: 3px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <strong style="color: #dc3545;">${errorType} Row ${error.row}</strong>
                                        <small style="color: #6c757d;">#${index + 1}</small>
                                    </div>
                                    <div style="margin: 8px 0; color: #721c24; background: #f8d7da; padding: 8px; border-radius: 3px; font-family: monospace; font-size: 12px;">
                                        ${error.error}
                                    </div>
                                    <div style="color: #6c757d; font-size: 12px;">
                                        <strong>Data:</strong> 
                                        Worker: <em>${error.data['Nom'] || 'N/A'}</em> | 
                                        ID: <em>${error.data['Num SAL'] || 'N/A'}</em> | 
                                        IMEI: <em>${error.data['IMEI T√©l√©phone (*#06#)'] || 'N/A'}</em> | 
                                        SIM: <em>${error.data['N¬∞ SIM'] || 'N/A'}</em>
                                    </div>
                                </div>
                            `;
                        });
                        
                        resultHtml += `</div>`;
                        
                        if (data.note) {
                            resultHtml += `<br><div style="background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; padding: 10px; border-radius: 5px;"><strong>üìù Note:</strong> ${data.note}</div>`;
                        }
                    }
                    
                    // Show performance info if available
                    if (data.processing_time) {
                        resultHtml += `<br><br><small style="color: #6c757d;">‚è±Ô∏è Processing completed in ${data.processing_time}s</small>`;
                    }
                    
                    resultDiv.innerHTML = resultHtml;
                    
                    // Clear the file input only on success
                    if ((data.errors || 0) === 0) {
                        fileInput.value = '';
                    }
                }
            })
            .catch(error => {
                // Re-enable button
                importBtn.disabled = false;
                importBtn.textContent = 'üöÄ Import CSV Data';
                
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `
                    <strong>‚ùå Network/Server Error</strong><br>
                    <div style="background: #f8d7da; padding: 10px; border-radius: 5px; margin: 10px 0;">
                        <strong>Error:</strong> ${error.message}
                    </div>
                    <div style="background: #d1ecf1; padding: 10px; border-radius: 5px;">
                        <strong>üí° Troubleshooting:</strong><br>
                        ‚Ä¢ Check if the server is running (docker-compose ps)<br>
                        ‚Ä¢ Verify the file format and encoding<br>
                        ‚Ä¢ Try with a smaller file first<br>
                        ‚Ä¢ Check browser console for more details
                    </div>
                `;
                console.error('Import error:', error);
            });
        });
    </script>
</body>
</html>
