{% extends "base.html" %}

{% block title %}Manage Users - Admin{% endblock %}

{% block page_title %}Manage System Users{% endblock %}

{% block content %}
<div class="bg-white p-6 rounded-lg shadow">
    <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-semibold">User Accounts</h2>
        <button id="add-user-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded">
            Add New User
        </button>
    </div>
    <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
            <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Username</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Full Name</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
            </tr>
        </thead>
        <tbody id="users-table-body" class="bg-white divide-y divide-gray-200">
            <!-- JS will populate this -->
        </tbody>
    </table>
</div>

<!-- Add/Edit User Modal -->
<div id="user-modal" class="fixed z-10 inset-0 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <form id="user-form">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">Add New User</h3>
                    <input type="hidden" id="user-db-id" name="id">
                    <div class="mt-4 grid grid-cols-1 gap-y-4 sm:grid-cols-2 sm:gap-x-4">
                        <div>
                            <label for="username" class="block text-sm font-medium text-gray-700">Username*</label>
                            <input type="text" name="username" id="username" required class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                        </div>
                        <div>
                            <label for="full_name" class="block text-sm font-medium text-gray-700">Full Name*</label>
                            <input type="text" name="full_name" id="full_name" required class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                        </div>
                        <div class="sm:col-span-2">
                            <label for="email" class="block text-sm font-medium text-gray-700">Email*</label>
                            <input type="email" name="email" id="email" required class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                        </div>
                        <div>
                            <label for="role_id" class="block text-sm font-medium text-gray-700">Role*</label>
                            <select id="role_id" name="role_id" required class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                <!-- Options populated by JS -->
                            </select>
                        </div>
                        <div id="password-field-container">
                            <label for="password" class="block text-sm font-medium text-gray-700">Password*</label>
                            <input type="password" name="password" id="password" required class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="submit" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 sm:ml-3 sm:w-auto sm:text-sm">Save</button>
                    <button type="button" id="cancel-btn" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div id="toast" class="fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg hidden"><p id="toast-message"></p></div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const modal = document.getElementById('user-modal');
        const addUserBtn = document.getElementById('add-user-btn');
        const cancelBtn = document.getElementById('cancel-btn');
        const userForm = document.getElementById('user-form');
        const modalTitle = document.getElementById('modal-title');
        const tableBody = document.getElementById('users-table-body');
        const roleSelect = document.getElementById('role_id');
        const passwordContainer = document.getElementById('password-field-container');
        const passwordInput = document.getElementById('password');
        const toastMessage = document.getElementById('toast-message');

        let rolesData = [];

        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            toastMessage.textContent = message;
            toast.className = `fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg ${isError ? 'bg-red-500' : 'bg-green-500'}`;
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 3000);
        }

        function openModal() { modal.classList.remove('hidden'); }
        function closeModal() { modal.classList.add('hidden'); userForm.reset(); document.getElementById('user-db-id').value = ''; }

        addUserBtn.addEventListener('click', () => {
            modalTitle.textContent = 'Add New User';
            passwordContainer.style.display = 'block';
            passwordInput.required = true;
            document.getElementById('username').readOnly = false;
            openModal();
        });
        cancelBtn.addEventListener('click', closeModal);

        async function fetchRoles() {
            try {
                const response = await fetch('/api/roles');
                rolesData = await response.json();
                roleSelect.innerHTML = '<option value="">Select a role</option>';
                rolesData.forEach(role => {
                    roleSelect.innerHTML += `<option value="${role.id}">${role.role_name}</option>`;
                });
            } catch (error) { showToast('Could not load roles.', true); }
        }

        async function fetchUsers() {
            try {
                const response = await fetch('/api/users');
                const users = await response.json();
                renderTable(users);
            } catch (error) { showToast('Could not load users.', true); }
        }

        function renderTable(users) {
            tableBody.innerHTML = '';
            users.forEach(user => {
                const row = `
                    <tr data-user='${JSON.stringify(user)}'>
                        <td class="px-6 py-4 whitespace-nowrap">${user.username}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${user.full_name}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${user.email}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${user.role_name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button data-id="${user.id}" class="edit-btn text-indigo-600 hover:text-indigo-900">Edit</button>
                        </td>
                    </tr>
                `;
                tableBody.insertAdjacentHTML('beforeend', row);
            });
        }

        userForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(userForm);
            const userData = Object.fromEntries(formData.entries());
            const userDbId = userData.id;
            
            const url = userDbId ? `/api/users/${userDbId}` : '/api/users';
            const method = userDbId ? 'PUT' : 'POST';

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(userData)
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.error || 'Failed to save user.');
                showToast(`User successfully ${userDbId ? 'updated' : 'created'}!`);
                closeModal();
                fetchUsers();
            } catch (error) { showToast(error.message, true); }
        });

        tableBody.addEventListener('click', async function(e) {
            if (e.target.classList.contains('edit-btn')) {
                const row = e.target.closest('tr');
                const user = JSON.parse(row.dataset.user);
                
                document.getElementById('user-db-id').value = user.id;
                document.getElementById('username').value = user.username;
                document.getElementById('username').readOnly = true; // Don't allow username change
                document.getElementById('full_name').value = user.full_name;
                document.getElementById('email').value = user.email;

                const role = rolesData.find(r => r.role_name === user.role_name);
                if (role) document.getElementById('role_id').value = role.id;
                
                // Hide password field for editing
                passwordContainer.style.display = 'none';
                passwordInput.required = false;

                modalTitle.textContent = 'Edit User';
                openModal();
            }
        });

        fetchRoles();
        fetchUsers();
    });
</script>
{% endblock %}
