{% extends "manager/base.html" %}
{% block title %}Déclarer un Retour de Téléphone{% endblock %}
{% block page_title %}Déclarer un Retour de Téléphone{% endblock %}

{% block styles %}
<style>
.custom-form-group {
    position: relative;
}
</style>
{% endblock %}

{% block content %}
<div class="custom-card max-w-2xl mx-auto">
    <div class="card-header"><h2 class="card-title">Formulaire de Retour de Mobile</h2></div>
    <form id="return-form" class="p-4">
        <div class="space-y-4">
            <div class="custom-form-group">
                <label for="sector-filter" class="custom-label">Filtrer par secteur</label>
                <select id="sector-filter" class="custom-select">
                    <option value="">Tous les secteurs</option>
                </select>
            </div>
            
            <div class="custom-form-group">
                <label for="worker-select" class="custom-label">Sélectionner un travailleur</label>
                <select id="worker-select" class="custom-select">
                    <option value="">Choisissez un travailleur...</option>
                </select>
            </div>
            
            <div class="custom-form-group" id="selected-worker-group" style="display: none;">
                <label class="custom-label">Travailleur sélectionné</label>
                <div id="selected-worker-info" class="p-3 bg-blue-50 border border-blue-200 rounded-md">
                    <div class="font-medium" id="selected-worker-name"></div>
                    <div class="text-sm text-gray-600" id="selected-worker-details"></div>
                </div>
                <input type="hidden" id="selected-assignment-data">
            </div>
            
            <div class="custom-form-group">
                <label class="custom-label">Accessoires Retournés*</label>
                <div class="mt-2 space-y-2">
                    <div class="flex items-center"><input id="cable" type="checkbox" name="accessories" value="cable" class="h-4 w-4"><label for="cable" class="ml-2">Câble</label></div>
                    <div class="flex items-center"><input id="chargeur" type="checkbox" name="accessories" value="chargeur" class="h-4 w-4"><label for="chargeur" class="ml-2">Chargeur</label></div>
                    <div class="flex items-center"><input id="boite" type="checkbox" name="accessories" value="boite" class="h-4 w-4"><label for="boite" class="ml-2">Boîte</label></div>
                </div>
            </div>

            <div class="custom-form-group">
                <label for="condition-select" class="custom-label">État du mobile*</label>
                <select id="condition-select" name="condition" required class="custom-select">
                    <option value="">Sélectionnez un état...</option>
                    <option value="Comme neuf">Comme neuf</option>
                    <option value="Bon état">Bon état</option>
                    <option value="Rayures légères">Rayures légères</option>
                    <option value="Endommagé">Endommagé</option>
                    <option value="Ne s'allume pas">Ne s'allume pas</option>
                </select>
            </div>

            <div class="custom-form-group">
                <label for="notes" class="custom-label">Notes (dégâts, etc.)</label>
                <textarea id="notes" name="notes" rows="3" class="custom-textarea" placeholder="Décrivez tout dommage visible..."></textarea>
            </div>
        </div>
        <div class="custom-modal-footer">
            <button type="submit" class="btn btn-primary">Valider le Retour</button>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const sectorFilter = document.getElementById('sector-filter');
        const workerSelect = document.getElementById('worker-select');
        const selectedWorkerGroup = document.getElementById('selected-worker-group');
        const selectedWorkerName = document.getElementById('selected-worker-name');
        const selectedWorkerDetails = document.getElementById('selected-worker-details');
        const selectedAssignmentData = document.getElementById('selected-assignment-data');
        const returnForm = document.getElementById('return-form');
        
        let allPhones = [];
        let filteredPhones = [];

        async function loadReturnablePhones() {
            try {
                const response = await fetch('/api/manager/returnable_phones');
                allPhones = await response.json();
                populateSectorFilter();
                filterPhones();
                // Ne pas charger les travailleurs au début - attendre qu'un secteur soit sélectionné
            } catch (error) {
                console.error('Erreur lors du chargement des téléphones :', error);
            }
        }

        function populateSectorFilter() {
            const sectors = [...new Set(allPhones.map(p => p.secteur_name))].sort();
            sectorFilter.innerHTML = '<option value="">Tous les secteurs</option>';
            sectors.forEach(sector => {
                sectorFilter.innerHTML += `<option value="${sector}">${sector}</option>`;
            });
        }

        function filterPhones() {
            const sectorValue = sectorFilter.value;
            filteredPhones = sectorValue ? 
                allPhones.filter(p => p.secteur_name === sectorValue) : 
                allPhones;
        }

        function populateWorkerSelect() {
            workerSelect.innerHTML = '<option value="">Choisissez un travailleur...</option>';
            
            // Ne charger les travailleurs que si un secteur est sélectionné
            if (!sectorFilter.value) {
                const option = document.createElement('option');
                option.value = "";
                option.textContent = "Veuillez d'abord sélectionner un secteur";
                option.disabled = true;
                workerSelect.appendChild(option);
                return;
            }
            
            // Create unique workers from filtered phones
            const uniqueWorkers = filteredPhones.reduce((acc, phone) => {
                const key = `${phone.worker_id}_${phone.assignment_id}`;
                if (!acc[key]) {
                    acc[key] = phone;
                }
                return acc;
            }, {});

            // Sort workers by name
            const sortedWorkers = Object.values(uniqueWorkers).sort((a, b) => 
                a.worker_name.localeCompare(b.worker_name)
            );

            sortedWorkers.forEach(worker => {
                const option = document.createElement('option');
                option.value = JSON.stringify({
                    assignment_id: worker.assignment_id,
                    phone_id: worker.phone_id,
                    worker_id: worker.worker_id
                });
                option.textContent = `${worker.worker_name} - ${worker.secteur_name} (${worker.manufacturer} ${worker.model})`;
                option.dataset.workerData = JSON.stringify(worker);
                workerSelect.appendChild(option);
            });
        }

        function selectWorker(workerData) {
            selectedWorkerName.textContent = workerData.worker_name;
            selectedWorkerDetails.textContent = `${workerData.secteur_name} • ${workerData.manufacturer} ${workerData.model} (${workerData.asset_tag})`;
            selectedAssignmentData.value = JSON.stringify({
                assignment_id: workerData.assignment_id,
                phone_id: workerData.phone_id,
                worker_id: workerData.worker_id
            });
            
            selectedWorkerGroup.style.display = 'block';
        }

        // Event Listeners
        sectorFilter.addEventListener('change', function() {
            filterPhones();
            populateWorkerSelect();
            selectedWorkerGroup.style.display = 'none';
            workerSelect.value = '';
        });

        workerSelect.addEventListener('change', function() {
            if (this.value) {
                const workerData = JSON.parse(this.options[this.selectedIndex].dataset.workerData);
                selectedAssignmentData.value = this.value;
                selectWorker(workerData);
            } else {
                selectedWorkerGroup.style.display = 'none';
                selectedAssignmentData.value = '';
            }
        });

        returnForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!selectedAssignmentData.value) {
                alert('Veuillez sélectionner un travailleur');
                return;
            }
            
            const selectedData = JSON.parse(selectedAssignmentData.value);
            const accessories = Array.from(document.querySelectorAll('input[name="accessories"]:checked')).map(el => el.value);
            
            const payload = {
                ...selectedData,
                accessories: accessories,
                condition: document.getElementById('condition-select').value,
                notes: document.getElementById('notes').value
            };

            try {
                const response = await fetch('/api/manager/return_phone', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.error);
                
                alert('Retour enregistré !');
                window.location.href = "{{ url_for('manager_dashboard') }}";
            } catch (error) {
                alert(`Erreur : ${error.message}`);
            }
        });

        loadReturnablePhones();
    });
</script>
{% endblock %}
```