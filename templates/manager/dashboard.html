{% extends "base.html" %}
{% block title %}Manager Dashboard{% endblock %}

{% block page_title %}Team Dashboard{% endblock %}

{% block content %}
<div class="custom-card">
    <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-semibold">My Team's Status</h2>
        <button id="create-ticket-btn" class="btn btn-primary">Create New Ticket</button>
    </div>
    <div class="overflow-x-auto">
        <table class="custom-table">
            <thead>
                <tr>
                    <th>Worker Name</th>
                    <th>Assigned Phone</th>
                    <th>Phone Status</th>
                    <th>Support Status</th>
                </tr>
            </thead>
            <tbody id="team-status-table-body">
                <!-- JS will populate this -->
            </tbody>
        </table>
    </div>
</div>

<!-- Create Ticket Modal -->
<div id="ticket-modal" class="custom-modal hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="custom-modal-backdrop"></div>
    <div class="custom-modal-content">
        <form id="ticket-form" class="custom-form">
            <div class="custom-modal-header">
                <h3 id="modal-title" class="custom-modal-title">Create New Support Ticket</h3>
            </div>
            <div class="custom-modal-body">
                <div class="custom-form-grid">
                    <div class="custom-form-group custom-form-group-full">
                        <label for="phone_id" class="custom-label">Worker / Phone*</label>
                        <select id="phone_id" name="phone_id" required class="custom-input">
                            <option value="">Select a worker's phone...</option>
                            <!-- Options populated by JS -->
                        </select>
                    </div>
                    <div class="custom-form-group">
                        <label for="title" class="custom-label">Issue Title*</label>
                        <input type="text" name="title" id="title" required class="custom-input" placeholder="e.g., Screen is cracked">
                    </div>
                    <div class="custom-form-group">
                        <label for="priority" class="custom-label">Priority*</label>
                        <select id="priority" name="priority" required class="custom-input">
                            <option>Low</option>
                            <option>Medium</option>
                            <option>High</option>
                            <option>Urgent</option>
                        </select>
                    </div>
                    <div class="custom-form-group custom-form-group-full">
                        <label for="description" class="custom-label">Full Description*</label>
                        <textarea id="description" name="description" rows="4" required class="custom-input" placeholder="Please provide as much detail as possible..."></textarea>
                    </div>
                </div>
            </div>
            <div class="custom-modal-footer">
                <button type="button" id="cancel-ticket-btn" class="btn btn-secondary">Cancel</button>
                <button type="submit" class="btn btn-primary">Submit Ticket</button>
            </div>
        </form>
    </div>
</div>

<!-- Toast Notification -->
<div id="toast" class="fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg hidden">
    <p id="toast-message"></p>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const tableBody = document.getElementById('team-status-table-body');
        
        // Modal elements
        const ticketModal = document.getElementById('ticket-modal');
        const createTicketBtn = document.getElementById('create-ticket-btn');
        const cancelTicketBtn = document.getElementById('cancel-ticket-btn');
        const ticketForm = document.getElementById('ticket-form');
        const phoneSelect = document.getElementById('phone_id');

        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            toastMessage.textContent = message;
            toast.className = `fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg ${isError ? 'bg-red-500' : 'bg-green-500'}`;
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 3000);
        }

        async function fetchTeamStatus() {
            try {
                const response = await fetch('/api/manager/team_status');
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to fetch team status');
                }
                const teamStatus = await response.json();
                renderTable(teamStatus);
            } catch (error) {
                showToast(error.message, true);
            }
        }

        function renderTable(teamStatus) {
            tableBody.innerHTML = '';
            if (teamStatus.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" class="text-center py-4">No workers found in your sectors.</td></tr>';
                return;
            }
            teamStatus.forEach(member => {
                const phoneInfo = member.asset_tag ? `${member.manufacturer} ${member.model} (${member.asset_tag})` : 'N/A';
                const phoneStatus = member.phone_status ? `<span class="status-badge ${member.phone_status.toLowerCase().replace(' ', '-')}">${member.phone_status}</span>` : 'N/A';
                
                let supportStatus;
                if (member.open_ticket_count > 0) {
                    supportStatus = `<span class="status-badge retired">${member.open_ticket_count} Open Ticket(s)</span>`;
                } else {
                    supportStatus = `<span class="status-badge active">OK</span>`;
                }

                const row = `
                    <tr>
                        <td class="font-medium">${member.worker_name}</td>
                        <td>${phoneInfo}</td>
                        <td>${phoneStatus}</td>
                        <td>${supportStatus}</td>
                    </tr>
                `;
                tableBody.insertAdjacentHTML('beforeend', row);
            });
        }

        // --- Ticket Modal Logic ---
        
        function openTicketModal() { ticketModal.classList.remove('hidden'); }
        function closeTicketModal() { ticketModal.classList.add('hidden'); ticketForm.reset(); }

        async function populateTicketForm() {
            try {
                const response = await fetch('/api/manager/selectable_phones');
                if (!response.ok) throw new Error('Could not load worker data.');
                const selectablePhones = await response.json();
                
                phoneSelect.innerHTML = '<option value="">Select a worker\'s phone...</option>';
                selectablePhones.forEach(phone => {
                    const optionText = `${phone.worker_name} - (${phone.manufacturer} ${phone.model}, ${phone.asset_tag})`;
                    phoneSelect.innerHTML += `<option value="${phone.phone_id}">${optionText}</option>`;
                });

            } catch (error) {
                showToast(error.message, true);
            }
        }

        createTicketBtn.addEventListener('click', () => {
            populateTicketForm();
            openTicketModal();
        });
        
        cancelTicketBtn.addEventListener('click', closeTicketModal);

        ticketForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(ticketForm);
            const ticketData = Object.fromEntries(formData.entries());

            try {
                const response = await fetch('/api/tickets', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(ticketData)
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.error || 'Failed to create ticket.');
                
                showToast('Ticket created successfully!');
                closeTicketModal();
                fetchTeamStatus(); // Refresh the main dashboard table
            } catch (error) {
                showToast(error.message, true);
            }
        });

        // Initial Load
        fetchTeamStatus();
    });
</script>
{% endblock %}
