{% extends "base.html" %}
{% block title %}{{ _('Manager Dashboard') }}{% endblock %}

{% block page_title %}{{ _('Team Dashboard') }}{% endblock %}

{% block content %}
<!-- Notifications Section -->
<div id="notifications-section" class="mb-6">
    <!-- JS will populate notifications here -->
</div>

<div class="custom-card">
    <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-semibold">{{ _("My Team's Status") }}</h2>
        <button id="create-ticket-btn" class="btn btn-primary">{{ _('Create New Ticket') }}</button>
    </div>
    <div class="overflow-x-auto">
        <table class="custom-table">
            <thead>
                <tr>
                    <th>{{ _('Worker Name') }}</th>
                    <th>{{ _('Assigned Phone') }}</th>
                    <th>{{ _('Phone Status') }}</th>
                    <th>{{ _('Support Status') }}</th>
                    <th>{{ _('Actions') }}</th>
                </tr>
            </thead>
            <tbody id="team-status-table-body">
                <!-- JS will populate this -->
            </tbody>
        </table>
    </div>
</div>

<!-- Create Ticket Modal -->
<div id="ticket-modal" class="custom-modal hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="custom-modal-backdrop"></div>
    <div class="custom-modal-content">
        <form id="ticket-form" class="custom-form">
            <div class="custom-modal-header">
                <h3 id="modal-title" class="custom-modal-title">Create New Support Ticket</h3>
            </div>
            <div class="custom-modal-body">
                <div class="custom-form-grid">
                    <div class="custom-form-group custom-form-group-full">
                        <label for="phone_id" class="custom-label">Worker / Phone*</label>
                        <select id="phone_id" name="phone_id" required class="custom-input">
                            <option value="">Select a worker's phone...</option>
                            <!-- Options populated by JS -->
                        </select>
                    </div>
                    <div class="custom-form-group">
                        <label for="title" class="custom-label">Issue Title*</label>
                        <input type="text" name="title" id="title" required class="custom-input" placeholder="e.g., Screen is cracked">
                    </div>
                    <div class="custom-form-group">
                        <label for="priority" class="custom-label">Priority*</label>
                        <select id="priority" name="priority" required class="custom-input">
                            <option>Low</option>
                            <option>Medium</option>
                            <option>High</option>
                            <option>Urgent</option>
                        </select>
                    </div>
                    <div class="custom-form-group custom-form-group-full">
                        <label for="description" class="custom-label">Full Description*</label>
                        <textarea id="description" name="description" rows="4" required class="custom-input" placeholder="Please provide as much detail as possible..."></textarea>
                    </div>
                </div>
            </div>
            <div class="custom-modal-footer">
                <button type="button" id="cancel-ticket-btn" class="btn btn-secondary">Cancel</button>
                <button type="submit" class="btn btn-primary">Submit Ticket</button>
            </div>
        </form>
    </div>
</div>

<!-- Toast Notification -->
<div id="toast" class="fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg hidden">
    <p id="toast-message"></p>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const tableBody = document.getElementById('team-status-table-body');
        
        // Modal elements
        const ticketModal = document.getElementById('ticket-modal');
        const createTicketBtn = document.getElementById('create-ticket-btn');
        const cancelTicketBtn = document.getElementById('cancel-ticket-btn');
        const ticketForm = document.getElementById('ticket-form');
        const phoneSelect = document.getElementById('phone_id');

        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            toastMessage.textContent = message;
            toast.className = `fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg ${isError ? 'bg-red-500' : 'bg-green-500'}`;
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 3000);
        }

        async function fetchTeamStatus() {
            try {
                const response = await fetch('/api/manager/team_status');
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to fetch team status');
                }
                const teamStatus = await response.json();
                renderNotifications(teamStatus);
                renderTable(teamStatus);
            } catch (error) {
                showToast(error.message, true);
            }
        }

        function renderNotifications(teamStatus) {
            const notificationsSection = document.getElementById('notifications-section');
            const pendingSwaps = teamStatus.filter(member => member.pending_swaps > 0);
            
            if (pendingSwaps.length === 0) {
                notificationsSection.innerHTML = '';
                return;
            }

            let notificationsHtml = `
                <div class="custom-card phone-swap-notification">
                    <div class="card-header">
                        <h2 class="card-title">
                            <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.728-.833-2.498 0L4.316 15.5c-.77.833.192 2.5 1.732 2.5z"></path>
                            </svg>
                            Incoming Phone Deliveries (${pendingSwaps.length})
                        </h2>
                    </div>
                    <div class="p-4">
                        <div class="mb-4 p-3 phone-swap-tips rounded-lg">
                            <h4 class="font-semibold mb-2">ðŸ“± Phone Swap Planning Tips:</h4>
                            <ul class="text-sm space-y-1">
                                <li>â€¢ <strong>Plan ahead:</strong> If you know when the phone will arrive, contact the worker to schedule the swap</li>
                                <li>â€¢ <strong>Return items:</strong> Ask worker to bring back the charging cable and charger</li>
                                <li>â€¢ <strong>Box condition:</strong> Only return the box if it's in good shape - otherwise they can keep it</li>
                                <li>â€¢ <strong>Earbuds:</strong> Worker can keep earbuds if they've been used</li>
                            </ul>
                        </div>
                        <div class="space-y-2">
            `;

            pendingSwaps.forEach(member => {
                const timeSince = member.latest_swap_initiated ? 
                    `Initiated ${new Date(member.latest_swap_initiated).toLocaleDateString()}` : 
                    'Recently initiated';
                    
                notificationsHtml += `
                    <div class="flex items-center justify-between p-3 bg-white border border-blue-200 rounded-lg">
                        <div class="flex items-center">
                            <div class="w-3 h-3 bg-blue-500 rounded-full mr-3"></div>
                            <div>
                                <span class="font-medium">${member.worker_name}</span>
                                <span class="text-gray-600">- ${member.asset_tag || 'Phone'} replacement</span>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="text-xs text-gray-500">${timeSince}</span>
                            ${member.swap_ticket_id ? `<a href="/manager/ticket/${member.swap_ticket_id}" class="btn-link text-sm">View Ticket</a>` : ''}
                        </div>
                    </div>
                `;
            });

            notificationsHtml += `
                        </div>
                    </div>
                </div>
            `;

            notificationsSection.innerHTML = notificationsHtml;
        }

        function renderTable(teamStatus) {
            tableBody.innerHTML = '';
            if (teamStatus.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4">No workers found in your sectors.</td></tr>';
                return;
            }
            teamStatus.forEach(member => {
                const phoneInfo = member.asset_tag ? `${member.manufacturer} ${member.model} (${member.asset_tag})` : 'N/A';
                const phoneStatus = member.phone_status ? `<span class="status-badge ${member.phone_status.toLowerCase().replace(' ', '-')}">${member.phone_status}</span>` : 'N/A';
                
                let supportStatus;
                if (member.open_ticket_count > 0) {
                    supportStatus = `<span class="status-badge retired">${member.open_ticket_count} Open Ticket(s)</span>`;
                } else {
                    supportStatus = `<span class="status-badge active">OK</span>`;
                }

                // Add pending swap indicator to support status if applicable
                if (member.pending_swaps > 0) {
                    supportStatus += ` <span class="swap-en-route-badge">ðŸ“± Replacement En Route</span>`;
                }

                // Actions column
                let actions = '';
                if (member.pending_swaps > 0 && member.swap_ticket_id) {
                    actions = `<a href="/manager/ticket/${member.swap_ticket_id}" class="btn-link text-sm">View Swap Details</a>`;
                } else if (member.phone_id) {
                    actions = `<button onclick="createTicketForPhone(${member.phone_id})" class="btn-link text-sm">Create Ticket</button>`;
                } else {
                    actions = '<span class="text-gray-400 text-sm">No phone assigned</span>';
                }

                const row = `
                    <tr class="${member.pending_swaps > 0 ? 'pending-swap-row' : ''}">
                        <td class="font-medium">
                            ${member.worker_name}
                            ${member.pending_swaps > 0 ? '<span class="ml-2 phone-swap-indicator"></span>' : ''}
                        </td>
                        <td>${phoneInfo}</td>
                        <td>${phoneStatus}</td>
                        <td>${supportStatus}</td>
                        <td>${actions}</td>
                    </tr>
                `;
                tableBody.insertAdjacentHTML('beforeend', row);
            });
        }

        // --- Ticket Modal Logic ---
        
        function openTicketModal() { ticketModal.classList.remove('hidden'); }
        function closeTicketModal() { ticketModal.classList.add('hidden'); ticketForm.reset(); }

        // Function to create ticket for a specific phone (called from Actions column)
        window.createTicketForPhone = function(phoneId) {
            openTicketModal();
            populateTicketForm().then(() => {
                // Pre-select the phone in the dropdown
                const phoneSelect = document.getElementById('phone_id');
                phoneSelect.value = phoneId;
            });
        }

        async function populateTicketForm() {
            try {
                const response = await fetch('/api/manager/selectable_phones');
                if (!response.ok) throw new Error('Could not load worker data.');
                const selectablePhones = await response.json();
                
                phoneSelect.innerHTML = '<option value="">Select a worker\'s phone...</option>';
                selectablePhones.forEach(phone => {
                    const optionText = `${phone.worker_name} - (${phone.manufacturer} ${phone.model}, ${phone.asset_tag})`;
                    phoneSelect.innerHTML += `<option value="${phone.phone_id}">${optionText}</option>`;
                });

            } catch (error) {
                showToast(error.message, true);
            }
        }

        createTicketBtn.addEventListener('click', () => {
            populateTicketForm();
            openTicketModal();
        });
        
        cancelTicketBtn.addEventListener('click', closeTicketModal);

        ticketForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(ticketForm);
            const ticketData = {
                phone_id: parseInt(formData.get('phone_id')) || null,
                title: formData.get('title'),
                description: formData.get('description'),
                priority: formData.get('priority')
            };

            // Validate required fields on client side
            if (!ticketData.phone_id) {
                showToast('Please select a worker/phone before submitting the ticket.', true);
                return;
            }

            try {
                const response = await fetch('/api/tickets', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(ticketData)
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.error || 'Failed to create ticket.');
                
                showToast('Ticket created successfully!');
                closeTicketModal();
                fetchTeamStatus(); // Refresh the main dashboard table
            } catch (error) {
                showToast(error.message, true);
            }
        });

        // Initial Load
        fetchTeamStatus();
    });
</script>
{% endblock %}
