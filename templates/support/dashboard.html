{% extends "base.html" %}
{% block title %}Support Helpdesk{% endblock %}

{% block page_title %}Support Helpdesk{% endblock %}

{% block content %}
<div class="custom-card">
    <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-semibold">Active Support Tickets</h2>
    </div>
    <div class="overflow-x-auto">
        <table class="custom-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Priority</th>
                    <th>Title</th>
                    <th>Phone Asset</th>
                    <th>Reported By</th>
                    <th>Assigned To</th>
                    <th>Status</th>
                    <th class="text-right">Actions</th>
                </tr>
            </thead>
            <tbody id="tickets-table-body">
                <!-- JS will populate this -->
            </tbody>
        </table>
    </div>
</div>

<!-- Toast Notification -->
<div id="toast" class="fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg hidden">
    <p id="toast-message"></p>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const tableBody = document.getElementById('tickets-table-body');

        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            toastMessage.textContent = message;
            toast.className = `fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg ${isError ? 'bg-red-500' : 'bg-green-500'}`;
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 3000);
        }

        function formatPriority(priority) {
            const colors = {
                'Urgent': 'bg-red-600 text-white',
                'High': 'bg-amber-500 text-white',
                'Medium': 'bg-sky-500 text-white',
                'Low': 'bg-gray-400 text-white'
            };
            return `<span class="px-2 py-1 text-xs font-bold rounded-full ${colors[priority] || 'bg-gray-200'}">${priority}</span>`;
        }

        async function fetchActiveTickets() {
            try {
                const response = await fetch('/api/support/tickets');
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to fetch tickets');
                }
                const tickets = await response.json();
                renderTable(tickets);
            } catch (error) {
                showToast(error.message, true);
            }
        }

        function renderTable(tickets) {
            tableBody.innerHTML = '';
            if (tickets.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="8" class="text-center py-4">No active tickets found. Great job!</td></tr>';
                return;
            }
            tickets.forEach(ticket => {
                const row = `
                    <tr>
                        <td class="font-mono text-sm">#${ticket.ticket_id}</td>
                        <td>${formatPriority(ticket.priority)}</td>
                        <td class="font-medium">${ticket.title}</td>
                        <td>${ticket.phone_asset_tag}</td>
                        <td>${ticket.reported_by}</td>
                        <td>${ticket.assigned_to || '<span class="text-gray-400">Unassigned</span>'}</td>
                        <td>
                            <span class="status-badge ${ticket.status.toLowerCase()}">${ticket.status}</span>
                        </td>
                        <td class="text-right">
                            <a href="/support/ticket/${ticket.ticket_id}" class="btn-link">View Details</a>
                        </td>
                    </tr>
                `;
                tableBody.insertAdjacentHTML('beforeend', row);
            });
        }

        // Initial Load
        fetchActiveTickets();
    });
</script>
{% endblock %}
