<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV Import Wizard - Test</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; }
        .step { border: 1px solid #ddd; padding: 20px; margin: 20px 0; border-radius: 8px; }
        .hidden { display: none; }
        .step-active { background: #f0f9ff; border-color: #0ea5e9; }
        button { background: #0ea5e9; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        select, input[type="file"], input[type="number"], input[type="text"] { padding: 8px; margin: 5px 0; border: 1px solid #ddd; border-radius: 4px; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background: #f9f9f9; }
        .upload-area { border: 2px dashed #ddd; padding: 40px; text-align: center; cursor: pointer; }
        .upload-area:hover { border-color: #0ea5e9; background: #f9f9f9; }
        
        /* Styles pour les options de formatage */
        .format-section { margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 5px; }
        .format-section h4 { margin-top: 0; color: #333; }
        .separator-options { display: flex; flex-wrap: wrap; gap: 15px; margin: 10px 0; }
        .separator-options label { display: flex; align-items: center; gap: 5px; }
        .custom-separator { display: flex; align-items: center; gap: 5px; }
        .preview-box { 
            max-height: 200px; 
            overflow: auto; 
            border: 1px solid #ccc; 
            padding: 10px; 
            background: white; 
            font-family: 'Courier New', monospace; 
            font-size: 12px;
            line-height: 1.4;
        }
        .preview-line {
            margin: 3px 0;
            padding: 3px 5px;
            background: #f5f5f5;
            border-radius: 3px;
            border-left: 3px solid #0ea5e9;
        }
        .option-row {
            display: flex;
            align-items: center;
            margin: 8px 0;
            gap: 10px;
        }
        .option-row label {
            min-width: 150px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>üîß Assistant d'Import CSV - Test</h1>
    
    <!-- √âtape 1: Upload du fichier et options de formatage -->
    <div id="step1" class="step step-active">
        <h2>√âtape 1: S√©lection du fichier et options d'import</h2>
        
        <!-- Upload du fichier -->
        <div class="upload-area" onclick="document.getElementById('csvFile').click()">
            <p>Cliquez ici pour s√©lectionner votre fichier CSV</p>
            <input type="file" id="csvFile" accept=".csv,.txt" style="display: none;">
        </div>
        
        <!-- Options de formatage -->
        <div id="formatOptions" class="hidden" style="margin-top: 20px; padding: 20px; border: 1px solid #ddd; border-radius: 8px; background: #f9f9f9;">
            <h3>Options d'import</h3>
            
            <!-- Jeu de caract√®res et langue -->
            <div class="format-section">
                <div class="option-row">
                    <label>Jeu de caract√®res :</label>
                    <select id="encoding">
                        <option value="UTF-8">Unicode (UTF-8)</option>
                        <option value="UTF-16">Unicode (UTF-16)</option>
                        <option value="ISO-8859-1">Western (ISO-8859-1)</option>
                        <option value="Windows-1252">Windows-1252</option>
                    </select>
                </div>
                
                <div class="option-row">
                    <label>Langue :</label>
                    <select id="language">
                        <option value="fr">Fran√ßais (France)</option>
                        <option value="en">English (US)</option>
                        <option value="en-GB">English (UK)</option>
                    </select>
                </div>
                
                <div class="option-row">
                    <label>√Ä partir de la ligne :</label>
                    <input type="number" id="startLine" value="1" min="1" style="width: 60px;">
                </div>
            </div>
            
            <!-- Options de s√©parateur -->
            <div class="format-section">
                <h4>Options de s√©parateur</h4>
                <div style="margin: 10px 0;">
                    <label><input type="radio" name="separatorType" value="fixed" id="fixedWidth"> Largeur fixe</label>
                    <label style="margin-left: 30px;"><input type="radio" name="separatorType" value="separated" id="separated" checked> S√©par√© par</label>
                </div>
                
                <div id="separatorOptions" style="margin-left: 20px; margin-top: 15px;">
                    <div class="separator-options">
                        <label><input type="checkbox" id="tabSeparator"> Tabulation</label>
                        <label><input type="checkbox" id="semicolonSeparator" checked> Point-virgule</label>
                        <label><input type="checkbox" id="commaSeparator"> Virgule</label>
                        <label><input type="checkbox" id="spaceSeparator"> Espace</label>
                    </div>
                    
                    <div class="custom-separator" style="margin-top: 10px;">
                        <label><input type="checkbox" id="customSeparator"> Autre :</label>
                        <input type="text" id="customSeparatorValue" placeholder="|" maxlength="1" style="width: 40px;">
                    </div>
                    
                    <div style="margin-top: 15px;">
                        <label><input type="checkbox" id="mergeSeparators"> Fusionner les s√©parateurs</label>
                    </div>
                    
                    <div class="option-row" style="margin-top: 15px;">
                        <label>S√©parateur de cha√Æne de caract√®res :</label>
                        <select id="textDelimiter">
                            <option value='"'>" (guillemets)</option>
                            <option value="'">' (apostrophe)</option>
                            <option value="">Aucun</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- Autres options -->
            <div class="format-section">
                <h4>Autres options</h4>
                <div style="margin: 10px 0;">
                    <label><input type="checkbox" id="formatFields"> Formater les champs entre guillemets comme texte</label>
                </div>
                <div style="margin: 10px 0;">
                    <label><input type="checkbox" id="detectNumbers" checked> D√©tecter les nombres sp√©ciaux</label>
                </div>
            </div>
            
            <!-- Aper√ßu du parsing -->
            <div class="format-section">
                <h4>Aper√ßu du parsing :</h4>
                <div id="parsePreview" class="preview-box"></div>
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                <button onclick="parseWithOptions()" style="font-size: 16px; padding: 12px 24px;">üìä Analyser et continuer</button>
            </div>
        </div>
        
        <div id="uploadStatus"></div>
    </div>

    <!-- √âtape 2: Preview & Select Table -->
    <div id="step2" class="step hidden">
        <h2>√âtape 2: Aper√ßu des donn√©es et s√©lection de table</h2>
        <div>
            <label>Table de destination:</label>
            <select id="targetTable">
                <option value="">-- Choisir une table --</option>
            </select>
        </div>
        <h3>Aper√ßu des donn√©es (5 premi√®res lignes):</h3>
        <div id="previewContainer"></div>
        <button onclick="showStep(3)" id="nextToMapping" disabled>Continuer vers le mapping</button>
    </div>

    <!-- √âtape 3: Map Columns -->
    <div id="step3" class="step hidden">
        <h2>√âtape 3: Association des colonnes</h2>
        <p>Associez chaque colonne CSV avec un champ de la base de donn√©es:</p>
        <div id="mappingContainer"></div>
        <button onclick="showStep(4)" id="nextToValidate" disabled>Valider l'import</button>
    </div>

    <!-- √âtape 4: Validate & Import -->
    <div id="step4" class="step hidden">
        <h2>√âtape 4: Validation et import</h2>
        <div id="validationSummary"></div>
        <button onclick="executeImport()" id="executeBtn">Ex√©cuter l'import</button>
        <div id="importResults"></div>
    </div>

    <script>
        let csvData = '';
        let csvHeaders = [];
        let previewData = [];
        let availableTables = [];
        let targetTable = '';
        let dbColumns = [];
        let columnMapping = {};
        let uploadId = null; // Pour stocker l'ID de session c√¥t√© serveur

        // √âtape 1: Upload du fichier
        document.getElementById('csvFile').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            document.getElementById('uploadStatus').innerHTML = '<p>üì§ Upload du fichier vers le serveur...</p>';
            
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                const response = await fetch('/api/import/upload', {
                    method: 'POST',
                    body: formData,
                    credentials: 'same-origin'
                });
                
                const data = await response.json();
                if (!response.ok) throw new Error(data.error);
                
                uploadId = data.upload_id;
                availableTables = data.tables;
                
                document.getElementById('uploadStatus').innerHTML = 
                    `<p style="color: green;">‚úÖ Fichier "${data.filename}" upload√© avec succ√®s!</p>
                     <p>üìä Taille: ${(data.file_size / 1024).toFixed(1)} KB | Encodage: ${data.encoding}</p>`;
                
                document.getElementById('formatOptions').classList.remove('hidden');
                
                // D√©clencher un premier aper√ßu avec les options par d√©faut
                showParsePreview();
                
            } catch (error) {
                document.getElementById('uploadStatus').innerHTML = 
                    `<p style="color: red;">‚ùå Erreur: ${error.message}</p>`;
            }
        });

        // Gestionnaires d'√©v√©nements pour les options
        document.addEventListener('DOMContentLoaded', function() {
            // √âv√©nements pour les s√©parateurs
            document.getElementById('tabSeparator').addEventListener('change', showParsePreview);
            document.getElementById('semicolonSeparator').addEventListener('change', showParsePreview);
            document.getElementById('commaSeparator').addEventListener('change', showParsePreview);
            document.getElementById('spaceSeparator').addEventListener('change', showParsePreview);
            document.getElementById('customSeparator').addEventListener('change', showParsePreview);
            document.getElementById('customSeparatorValue').addEventListener('input', showParsePreview);
            document.getElementById('textDelimiter').addEventListener('change', showParsePreview);
            document.getElementById('startLine').addEventListener('change', showParsePreview);
            document.getElementById('mergeSeparators').addEventListener('change', showParsePreview);
        });

        function getSelectedSeparators() {
            let separators = [];
            if (document.getElementById('tabSeparator').checked) separators.push('\t');
            if (document.getElementById('semicolonSeparator').checked) separators.push(';');
            if (document.getElementById('commaSeparator').checked) separators.push(',');
            if (document.getElementById('spaceSeparator').checked) separators.push(' ');
            if (document.getElementById('customSeparator').checked) {
                const customSep = document.getElementById('customSeparatorValue').value;
                if (customSep) separators.push(customSep);
            }
            return separators.length > 0 ? separators : [';']; // Par d√©faut point-virgule
        }

        function showParsePreview() {
            if (!uploadId) return;
            
            const separators = getSelectedSeparators();
            const textDelimiter = document.getElementById('textDelimiter').value;
            const startLine = parseInt(document.getElementById('startLine').value) || 1;
            const mergeSeparators = document.getElementById('mergeSeparators').checked;
            
            // Envoyer les options de parsing au serveur
            fetch('/api/import/parse', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    upload_id: uploadId,
                    separators: separators,
                    text_delimiter: textDelimiter,
                    start_line: startLine,
                    merge_separators: mergeSeparators
                }),
                credentials: 'same-origin'
            })
            .then(response => response.json())
            .then(data => {
                if (!data.headers) {
                    document.getElementById('parsePreview').innerHTML = 
                        '<div style="color: #dc3545; font-weight: bold;">‚ùå ' + (data.error || 'Erreur de parsing') + '</div>';
                    return;
                }
                
                // Mettre √† jour les variables globales
                csvHeaders = data.headers;
                previewData = data.preview_data;
                
                // Afficher l'aper√ßu
                displayParsePreview(data);
            })
            .catch(error => {
                document.getElementById('parsePreview').innerHTML = 
                    '<div style="color: #dc3545; font-weight: bold;">‚ùå Erreur: ' + error.message + '</div>';
            });
        }

        function displayParsePreview(data) {
            let previewHtml = '<div style="color: #28a745; font-weight: bold; margin-bottom: 10px;">‚úÖ ' + data.total_rows + ' ligne(s) de donn√©es d√©tect√©e(s)</div>';
            
            if (data.headers && data.headers.length > 0) {
                // Affichage sous forme de tableau
                previewHtml += '<table style="width: 100%; font-size: 11px; border-collapse: collapse;">';
                
                // Headers
                previewHtml += '<thead><tr style="background: #e9ecef;">';
                previewHtml += '<th style="padding: 4px; border: 1px solid #ccc; width: 60px;">Ligne</th>';
                data.headers.forEach((header, i) => {
                    previewHtml += '<th style="padding: 4px; border: 1px solid #ccc;">' + header + '</th>';
                });
                previewHtml += '</tr></thead><tbody>';
                
                // Ligne d'headers (ligne 1)
                previewHtml += '<tr style="background: #fff3cd;">';
                previewHtml += '<td style="padding: 4px; border: 1px solid #ccc; font-weight: bold; text-align: center;">' + data.parse_info.start_line + '</td>';
                data.headers.forEach(header => {
                    previewHtml += '<td style="padding: 4px; border: 1px solid #ccc; font-weight: bold;">' + header + '</td>';
                });
                previewHtml += '</tr>';
                
                // Donn√©es (5 premi√®res lignes)
                data.preview_data.forEach((row, i) => {
                    const bgColor = (i % 2 === 0) ? '#f8f9fa' : 'white';
                    previewHtml += '<tr style="background: ' + bgColor + ';">';
                    previewHtml += '<td style="padding: 4px; border: 1px solid #ccc; font-weight: bold; text-align: center;">' + (i + data.parse_info.start_line + 1) + '</td>';
                    
                    data.headers.forEach(header => {
                        const cellValue = row[header] || '';
                        const displayValue = cellValue.length > 20 ? cellValue.substring(0, 17) + '...' : cellValue;
                        previewHtml += '<td style="padding: 4px; border: 1px solid #ccc;" title="' + cellValue.replace(/"/g, '&quot;') + '">' + displayValue + '</td>';
                    });
                    previewHtml += '</tr>';
                });
                
                previewHtml += '</tbody></table>';
                
                if (data.total_rows > 5) {
                    previewHtml += '<div style="margin-top: 8px; color: #6c757d; font-style: italic;">... et ' + (data.total_rows - 5) + ' ligne(s) suppl√©mentaire(s)</div>';
                }
                
                // Informations de parsing
                previewHtml += '<div style="margin-top: 15px; padding: 8px; background: #e7f3ff; border-radius: 4px; font-size: 11px;">';
                previewHtml += '<strong>Informations de parsing :</strong><br>';
                previewHtml += 'üìä Lignes de donn√©es : ' + data.total_rows + ' | Colonnes : ' + data.columns_detected + '<br>';
                previewHtml += 'üîß S√©parateur(s) : ' + data.parse_info.separators_used.map(s => s === '\t' ? 'TAB' : s === ' ' ? 'ESPACE' : s).join(', ') + '<br>';
                if (data.parse_info.text_delimiter) previewHtml += 'üìù D√©limiteur de texte : ' + data.parse_info.text_delimiter + '<br>';
                previewHtml += 'üìç Ligne de d√©part : ' + data.parse_info.start_line;
                if (data.parse_info.merge_separators) previewHtml += '<br>üîó Fusion des s√©parateurs activ√©e';
                previewHtml += '</div>';
            }
            
            document.getElementById('parsePreview').innerHTML = previewHtml;
        }

        async function parseWithOptions() {
            if (!uploadId) {
                alert('Veuillez d\'abord s√©lectionner un fichier');
                return;
            }
            
            // Les donn√©es sont d√©j√† pars√©es c√¥t√© serveur via showParsePreview()
            if (!csvHeaders || csvHeaders.length === 0) {
                alert('Aucune donn√©e n\'a pu √™tre pars√©e. V√©rifiez vos options.');
                return;
            }
            
            populateStep2();
            showStep(2);
        }

        function populateStep2() {
            // Populer la liste des tables
            const tableSelect = document.getElementById('targetTable');
            tableSelect.innerHTML = '<option value="">-- Choisir une table --</option>';
            availableTables.forEach(table => {
                tableSelect.innerHTML += `<option value="${table}">${table}</option>`;
            });
            
            // Afficher l'aper√ßu des donn√©es
            let previewHtml = '<table><thead><tr>';
            csvHeaders.forEach(header => {
                previewHtml += `<th>${header}</th>`;
            });
            previewHtml += '</tr></thead><tbody>';
            
            previewData.forEach(row => {
                previewHtml += '<tr>';
                csvHeaders.forEach(header => {
                    previewHtml += `<td>${row[header] || ''}</td>`;
                });
                previewHtml += '</tr>';
            });
            previewHtml += '</tbody></table>';
            
            document.getElementById('previewContainer').innerHTML = previewHtml;
        }

        // S√©lection de table
        document.getElementById('targetTable').addEventListener('change', async function() {
            targetTable = this.value;
            const nextBtn = document.getElementById('nextToMapping');
            
            if (!targetTable) {
                nextBtn.disabled = true;
                return;
            }
            
            try {
                const response = await fetch('/api/import/schema', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ table_name: targetTable }),
                    credentials: 'same-origin'
                });
                
                const data = await response.json();
                if (!response.ok) throw new Error(data.error);
                
                dbColumns = data.columns;
                nextBtn.disabled = false;
                
            } catch (error) {
                alert(`Erreur lors de la r√©cup√©ration du sch√©ma: ${error.message}`);
                nextBtn.disabled = true;
            }
        });

        function populateStep3() {
            let mappingHtml = '<table><thead><tr><th>Colonne CSV</th><th>Champ BD</th></tr></thead><tbody>';
            
            csvHeaders.forEach((header, index) => {
                mappingHtml += '<tr>' +
                    '<td><strong>' + header + '</strong></td>' +
                    '<td>' +
                        '<select id="mapping_' + index + '" onchange="updateMapping()">' +
                            '<option value="">-- Ne pas importer --</option>';
                            
                dbColumns.forEach(col => {
                    const selected = col.toLowerCase() === header.toLowerCase() ? 'selected' : '';
                    mappingHtml += '<option value="' + col + '" ' + selected + '>' + col + '</option>';
                });
                
                mappingHtml += '</select>' +
                    '</td>' +
                '</tr>';
            });
            
            mappingHtml += '</tbody></table>';
            document.getElementById('mappingContainer').innerHTML = mappingHtml;
            updateMapping();
        }

        function updateMapping() {
            columnMapping = {};
            let hasMapping = false;
            
            csvHeaders.forEach((header, index) => {
                const select = document.getElementById(`mapping_${index}`);
                if (select.value) {
                    columnMapping[header] = select.value;
                    hasMapping = true;
                }
            });
            
            document.getElementById('nextToValidate').disabled = !hasMapping;
        }

        function populateStep4() {
            let summaryHtml = '<h3>R√©sum√© de l\'import:</h3>' +
                '<p><strong>Table de destination:</strong> ' + targetTable + '</p>' +
                '<p><strong>Nombre de lignes:</strong> ' + previewData.length + '</p>' +
                '<h4>Mapping des colonnes:</h4>' +
                '<ul>';
                
            for (const [csvCol, dbCol] of Object.entries(columnMapping)) {
                summaryHtml += '<li><strong>' + csvCol + '</strong> ‚Üí ' + dbCol + '</li>';
            }
            
            summaryHtml += '</ul>';
            document.getElementById('validationSummary').innerHTML = summaryHtml;
        }

        async function executeImport() {
            document.getElementById('importResults').innerHTML = '<p>‚è≥ Import en cours...</p>';
            
            try {
                const response = await fetch('/api/import/process-uploaded', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        upload_id: uploadId,
                        target_table: targetTable,
                        merge_key_csv: csvHeaders[0], // Premier champ comme cl√©
                        merge_key_db: columnMapping[csvHeaders[0]],
                        column_mappings: columnMapping
                    }),
                    credentials: 'same-origin'
                });
                
                const result = await response.json();
                if (!response.ok) throw new Error(result.error);
                
                document.getElementById('importResults').innerHTML = 
                    `<p style="color: green;">‚úÖ ${result.message}</p>
                     <p>üìä Lignes ins√©r√©es: ${result.inserted || 0}</p>
                     <p>üîÑ Lignes mises √† jour: ${result.updated || 0}</p>
                     <p>üìÅ Session nettoy√©e automatiquement</p>`;
                
            } catch (error) {
                document.getElementById('importResults').innerHTML = 
                    `<p style="color: red;">‚ùå Erreur: ${error.message}</p>`;
            }
        }

        function showStep(stepNumber) {
            // Cacher toutes les √©tapes
            for (let i = 1; i <= 4; i++) {
                document.getElementById(`step${i}`).classList.add('hidden');
                document.getElementById(`step${i}`).classList.remove('step-active');
            }
            
            // Afficher l'√©tape demand√©e
            document.getElementById(`step${stepNumber}`).classList.remove('hidden');
            document.getElementById(`step${stepNumber}`).classList.add('step-active');
            
            // Populer les donn√©es selon l'√©tape
            if (stepNumber === 3) populateStep3();
            if (stepNumber === 4) populateStep4();
        }
    </script>
</body>
</html>
