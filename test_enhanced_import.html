<!DOCTYPE html>
<html>
<head>
    <title>Enhanced CSV Import Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select { width: 100%; padding: 8px; box-sizing: border-box; }
        button { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .result { margin-top: 20px; padding: 15px; border-radius: 4px; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .mapping-section { background: #f8f9fa; padding: 15px; border-radius: 4px; margin: 15px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Enhanced Multi-Table CSV Import Test</h1>
        
        <form id="importForm" enctype="multipart/form-data">
            <div class="form-group">
                <label for="csvFile">Select CSV File:</label>
                <input type="file" id="csvFile" name="file" accept=".csv" required>
            </div>
            
            <div class="form-group">
                <label for="encoding">Encoding:</label>
                <select id="encoding" name="encoding">
                    <option value="utf-8">UTF-8</option>
                    <option value="latin1">Latin-1</option>
                    <option value="cp1252">Windows-1252</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="delimiter">Delimiter:</label>
                <select id="delimiter" name="delimiter">
                    <option value=";">Semicolon (;)</option>
                    <option value=",">Comma (,)</option>
                    <option value="\t">Tab</option>
                </select>
            </div>
            
            <div class="mapping-section">
                <h3>Column Mappings (Pre-configured for test CSV)</h3>
                <p>The mappings below are pre-configured for the test CSV with headers:</p>
                <code>Num SAL;Nom;Domaine d'Intervention;Contrat;Date Dernier contrat;N° SIM;OP;PUK;NUMERO;RIO;IMEI Téléphone (*#06#);Matèriel</code>
            </div>
            
            <button type="submit">Import CSV</button>
        </form>
        
        <div id="result" class="result" style="display: none;"></div>
    </div>

    <script>
        document.getElementById('importForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData();
            const fileInput = document.getElementById('csvFile');
            const encoding = document.getElementById('encoding').value;
            const delimiter = document.getElementById('delimiter').value;
            
            if (!fileInput.files[0]) {
                alert('Please select a CSV file');
                return;
            }
            
            // Pre-configured column mappings for the test CSV
            const columnMappings = {
                "worker_id": "Num SAL",
                "full_name": "Nom", 
                "secteur_name": "Domaine d'Intervention",
                "contract_type": "Contrat",
                "last_contract_date": "Date Dernier contrat",
                "iccid": "N° SIM",
                "carrier": "OP",
                "puk": "PUK",
                "phone_number": "NUMERO",
                "rio": "RIO",
                "imei": "IMEI Téléphone (*#06#)",
                "model": "Matèriel"
            };
            
            formData.append('file', fileInput.files[0]);
            formData.append('encoding', encoding);
            formData.append('delimiter', delimiter);
            formData.append('column_mappings', JSON.stringify(columnMappings));
            
            const resultDiv = document.getElementById('result');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            resultDiv.innerHTML = 'Processing...';
            
            fetch('/api/import/process', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = `<strong>Error:</strong> ${data.error}`;
                } else {
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `
                        <strong>Success!</strong><br>
                        ${data.message}<br>
                        Inserted: ${data.inserted || 0}<br>
                        Updated: ${data.updated || 0}<br>
                        Errors: ${data.errors || 0}
                    `;
                }
            })
            .catch(error => {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `<strong>Network Error:</strong> ${error.message}`;
            });
        });
    </script>
</body>
</html>
